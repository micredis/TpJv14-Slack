Grigory Kislin [6:25 AM]
joined #hw5.

Grigory Kislin [6:25 AM]
Добро пожаловать на урок 5: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md (edited)
Заканчиваем с базой данных (Spring Data JPA), на следующем уроке перейдем к слою web. (edited)

Kirilo [6:28 AM]
joined #hw5 along with 18 others.

Prodigy [12:31 PM]
Есть вопрос: в нашем многопользовательском приложении для каждого пользовательского запроса создается отдельный экземпляр EntityManager с своим контекстом хранения?


Yevhen Maksymovych [Yesterday at 12:47 PM]
Энтити менеджер создаётся на каждый запрос, а общий контекст, я так понимаю, сидит в фабрике


73 replies
e.pekhterev [1 day ago]
точно ли на каждый запрос? 
репозиторий у нас синглТон, у него есть поле *em*, и т.е. ты хочешь сказать на каждом запросе у нас это поле меняется (получает из фабрики новый экземпляр EntityManager)? (edited)


Prodigy [1 day ago]
я так понимаю что в каждой транзакции создается контекст хранения, который по закрытии транзакции закрывается, что с объектом EntityManager происходит, он существует один на всех или же он создается каждый раз?


Yevhen Maksymovych [1 day ago]
гхм, вот щаз задумался. документация говорит, что энтитименеджер легковесный объект, который является аналогом сессии, но здесь мы его действительно автовайрим при создании


Prodigy [1 day ago]
и как вообще тогда шарится объект EntityManager между пользователми


Yevhen Maksymovych [1 day ago]
думаю, проще всего поставить дебаг в какой-нибудь криэйт, вызвать его несколько раз кряду, и посмотреть, что происходит с энтитименеджером


Yevhen Maksymovych [1 day ago]
щаз под рукой нет ноута с проектом

e.pekhterev [1 day ago]
чёт я думал, что один на всех, особенно в том плане, что если мы создадим бин CriteriaBuilder по классике через xml и будем его автовааярить в репозитории, то по идее и он тогда должен переопределяться, короче спортное утверждение.


Yevhen Maksymovych [1 day ago]
дёрнуть его из нескольких сессий, и проверить, один он, или много его, собаки такой )) (edited)



e.pekhterev [1 day ago]
ща проверю

Yevhen Maksymovych [1 day ago]
если кто-то попробует, напишите, самому интересно, а то до ноута раньше вечера не доберусь


e.pekhterev [1 day ago]
дернул из разных браузеров и просто посмотрел что в туСтринге:
------------------!!!!!!!! ENTITY MANAGER !!!!!!!!!!!!!!----------------------
Shared EntityManager proxy for target factory [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@4a62b7dc]


e.pekhterev [1 day ago]
ну как бы один и тот же EM, что и требовалось доказать

Yevhen Maksymovych [1 day ago]
а контекст его вывести на каждом запросе?

e.pekhterev [1 day ago]
как?

e.pekhterev [1 day ago]
ааа, пропертиез


e.pekhterev [1 day ago]
хотя нет

e.pekhterev [1 day ago]
как вывести контекст?

Prodigy [1 day ago]
т.е. когда у нас в один момент куча пользователей пытается дергать данные из базы, один единственный объект EntityManager разрывается между всеми контекстами хранения пользователей? или может он в очередь ставит запросы от пользователей?


e.pekhterev [1 day ago]
черт его знает


e.pekhterev [1 day ago]
я попробовал из разных браузеро - и под юзером, и под админом ссылается на тот же объект EM

e.pekhterev [1 day ago]
ну оно и логично с точки зрения синглтона репозитория

Yevhen Maksymovych [1 day ago]
с точки зрения архитектуры вопросов нет, странно с точки зрения логики


Yevhen Maksymovych [1 day ago]
http://www.spring-source.ru/docs_simple.php?type=manual&theme=docs_simple&docs_simple=chap03_p03
spring-source.ru
Spring framework - Основные интерфейсы
Spring Framework на русском языке. Автор сайта: Бородин Артем. Категория: Программирование, Язык: русский. Тема: Spring framework Основные интерфейсы


Prodigy [1 day ago]
возможно тут можно проверить как, это посмотреть куда ссылается  объект EntityManager в каждом запросе пользователя (edited)

Yevhen Maksymovych [1 day ago]
вот тут в статье каждый рез берётся новый энтитименеджер для каждой новой транзакции


Prodigy [1 day ago]
это фабрика - org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@4a62b7dc

Yevhen Maksymovych [1 day ago]
может мы для простоты савтовайрили его, а на практике так делать не следует, следует вайрить фабрику?

e.pekhterev [1 day ago]
в том то и дело, что в нашем реешнии мы не юзаем явно транзакции, не коммитим их, и не закрываем после EM

Yevhen Maksymovych [1 day ago]
а, так там и есть фабрика


Yevhen Maksymovych [1 day ago]
я не глянул лог

e.pekhterev [1 day ago]
да, фабрика у нас, которая дает нам один EM с помощью аннотации @PersistenceContext

e.pekhterev [1 day ago]
Expresses a dependency on a container-managed EntityManager and its associated persistence context.

e.pekhterev [1 day ago]
т.е. контекст у нас всё же один для одного EM

e.pekhterev [1 day ago]
короче странно, нужно мнение менторов и объясннение, а то так не понятно


e.pekhterev [1 day ago]
а то это как то с требованиям ACID для трансакций не согласуется

Prodigy [1 day ago]
контекст у нас точно разный для каждой транзакции должен быть

e.pekhterev [1 day ago]
раз разный контекст, значит и разные EM должны быть

e.pekhterev [1 day ago]
но у нас один, либо я что то не так делаю

Prodigy [1 day ago]
по идее в каждом потоке должна быть своя копия данных и контекст хранения, который должен видимо создаваться фабрикой, значит и EntityManager должен быть уникальный


e.pekhterev [1 day ago]
в общем не понятно в чём тут суть

Yevhen Maksymovych [1 day ago]
а давайте позовём Дедушку Мороза

Yevhen Maksymovych [1 day ago]
не в том плане, что Григорий морозится, а в том, что дедушка мороз всегда выручит ))

Yevhen Maksymovych [1 day ago]
короче, надо мнение знатока :slightly_smiling_face:

e.pekhterev [1 day ago]
да хотя бы Снегурочка пришла что ли)))) (edited)

e.pekhterev [1 day ago]
@Yevhen Maksymovych добавь вызовы деда мороза и снегурочек в шапку этой ветки с помощью собак, может обратят внимание)) (edited)


Grigory Kislin [1 day ago]
@Prodigy честно- не понимаю...
есть целое первое видео + комментарий к нему снизу про EntityManager ...с прямым ответом на вопрос...



Prodigy [1 day ago]
:slightly_smiling_face::slightly_smiling_face::slightly_smiling_face:

e.pekhterev [1 day ago]
я ещё не смотрел))) сейчас приступлю))

Prodigy [1 day ago]
признаюсь, я еще не дошел до этого урока)

Prodigy [1 day ago]
начал разбираться с темой не в контексте данного урока

Prodigy [1 day ago]
довольно ясно, спасибо!


Merkulov [1 day ago]
EntityManager это по сути прокси обертка над Hibernate Session, которая создается каждый раз при открытии транзакции.

e.pekhterev [1 day ago]
кто создается))? обертка или сессия))? (edited)

Merkulov [1 day ago]
ну прочти еще раз)



e.pekhterev [1 day ago]
ну а ты читал, что мы выше обсуждали?

Stanislav [1 day ago]
http://www.adam-bien.com/roller/abien/entry/is_in_an_ejb_injected


Yevhen Maksymovych [1 day ago]
короче, по сути это пустышка, потому нет проблем, что она везде одна и та же. а при каждой транзакции под эту пустышку подтягивается новая сущность

e.pekhterev [1 day ago]
как я понимаю обертка (EM) таже, а вот сессии в ней каждый раз новые на каждую трансакцию

Stanislav [1 day ago]
 ```With an application-managed entity manager, on the other hand, the persistence context is not propagated to application components, and the lifecycle of EntityManager instances is managed by the application.

Application-managed entity managers are used when applications need to access a persistence context that is not propagated with the JTA transaction across EntityManager instances in a particular persistence unit. In this case, each EntityManager creates a new, isolated persistence context. The EntityManager and its associated persistence context are created and destroyed explicitly by the application. They are also used when directly injecting EntityManager instances can't be done because EntityManager instances are not thread-safe. EntityManagerFactory instances are thread-safe.``` 
(edited)


Yevhen Maksymovych [1 day ago]
вон оно чё

Alexander Pilipenko [1 day ago]
Интересно. А ссылку можно?

Stanislav [1 day ago]
https://docs.oracle.com/javaee/6/tutorial/doc/bnbqw.html



Alexander Pilipenko [1 day ago]
Погоди

Alexander Pilipenko [1 day ago]
У нас

Alexander Pilipenko [1 day ago]
Container-Managed Entity Managers
With a container-managed entity manager, an EntityManager instance’s persistence context is automatically propagated by the container to all application components that use the EntityManager instance within a single Java Transaction API (JTA) transaction.
JTA transactions usually involve calls across application components. To complete a JTA transaction, these components usually need access to a single persistence context. This occurs when an EntityManager is injected into the application components by means of the javax.persistence.PersistenceContext annotation. The persistence context is automatically propagated with the current JTA transaction, and EntityManager references that are mapped to the same persistence unit provide access to the persistence context within that transaction. By automatically propagating the persistence context, application components don’t need to pass references to EntityManager instances to each other in order to make changes within a single transaction. The Java EE container manages the lifecycle of container-managed entity managers.
To obtain an EntityManager instance, inject the entity manager into the application component:
@PersistenceContext
EntityManager em;


e.pekhterev [1 day ago]
вот именно

Alexander Pilipenko [1 day ago]
Жесть :slightly_smiling_face:

Stanislav [1 day ago]
Скинул книгу, страница 227

Alexander Pilipenko [1 day ago]
Как уже выше сказал Григорий - в уроке все  есть :slightly_smiling_face:

Alexander Pilipenko [1 day ago]
Дополнительно (ни разу не сталкивался): еще есть редкий случай ручного управления @PersistenceContext(type = PersistenceContextType.EXTENDED), когда он используется в нескольних транзакциях (long-running session or session-per-conversation). 
Spring and PersistenceContextType.EXTENDED
Transaction-scoped vs Extended Persistence


e.pekhterev [1 day ago]
уже поглядели))

Prodigy [1 day ago]
забавно переводят в разных книга persistance context: "контекст постоянства", "контекст хранения"


tim [4 hours ago]
One question that comes to mind is, how can @PersistenceContext inject an entity manager only once at container startup time, given that entity managers are so short lived, and that there are usually multiple per request.

The answer is that it can't: EntityManager is an interface, and what gets injected in the spring bean is not the entity manager itself but a context aware proxy that will delegate to a concrete entity manager at runtime.

Usually the concrete class used for the proxy is 
SharedEntityManagerInvocationHandler, this can be confirmed with the help a debugger.


Join_Selectovich [Yesterday at 1:42 PM]
Скажите может кто знает? я так подозревают что через HQL/JPQL нельзя сделать сложный запрос например с использованием аналитических функций... если нельзя то можно ли через Hibernate  отправить нативный оракловский запрос с использованием аналитических функций


1 reply
Grigory Kislin [1 day ago]
SQL+ NamedQuery c аттрибутом nativeQuery (edited)


Stanislav [Yesterday at 2:05 PM]
Страница 227
PDF
Изучаем_JavaEE7_2014.pdf
13 MB
PDF
 Click to view





4 replies
sky [1 day ago]
Немного не в тему вопрос, но может кто подскажет. Нужно приложение, с которого было бы удобно читать пдф на винде. На андроиде есть FBreader с плагином, который позволяет обрезать поля (лишнее) для всех страниц одновременно, имеет инверсную (или темную) тему отображения. Читалки что пробовал на винде норм, чтобы что-то глянуть, но читать в них - мучение..


Alexander Pilipenko [1 day ago]
https://ru.fbreader.org/win32
FBReader
FBReader для Windows
Стабильная версия 0.12.10
Oct 29th, 2011 at 10:16 PM


sky [1 day ago]
нагугливался в процессе поиска на это, но там "Последняя на сегодняшний день стабильная версия была выпущена в 2010 году", врядли там пдф плагин есть, хотя я не ставил..


Andrew [1 day ago]
А зачем лишний мусор в компе, через браузер, во вариант!)


Alexander Pilipenko [2:10 PM]
И за книжку спасибо :slightly_smiling_face:


Yevhen Maksymovych [Yesterday at 4:32 PM]
в новом релизе идея научилась строить диаграммы бинов спринга. выглядит, правда, как ночной кошмар


1 reply
Alexey_P [1 day ago]
видел у Тимура Батыршинова в курсе Spring видео 2014 года, там эклипс уже умел кажется


realcorwin [4:33 PM]
ночной кошмар студентки филологического факультета :slightly_smiling_face:


Maksim K [Yesterday at 9:39 PM]
Спасибо за книжечку. Чтоб кто еще про Hibernate на русском скинул книжечку))


14 replies
Stanislav [1 day ago]
В эл. варианте в нете ни чего нет (на русс.). Взял https://www.ozon.ru/context/detail/id/141415731/  и не пожалел. Ozon быстро доставляет (с учетом что я не в России).
Ozon.ru
Книга «Java Persistence API и Hibernate» Кристиан Бауэр, Гэвин Кинг, Гэри Грегори - купить на OZON.ru книгу с быстрой доставкой | 978-5-97060-180-8
Купить книгу «Java Persistence API и Hibernate» автора Кристиан Бауэр, Гэвин Кинг, Гэри Грегори и другие произведения в разделе Книги в интернет-магазине OZON.ru. Доступны цифровые, печатные и аудиокниги. На сайте вы можете почитать отзывы, рецензии, отрывки. Мы бесплатно доставим книгу «Java Persistence API и Hibernate» по Москве при общей сумме заказа от 3500 рублей. Возможна доставка по всей России. Скидки и бонусы для постоянных покупателей. (104 kB)
(edited)


Alexey_P [1 day ago]
написано - товар закончился. Все ломанулись похоже)


Alexey_P [1 day ago]
на английском есть 3 штуки, сам пока не читал.


Maksim K [1 day ago]
Ну я вот эту книжечку и имел ввиду) Сам ее в инете искал на русском скачать. Нету... Надо посмотреть скок стоит. Может купить


Maksim K [1 day ago]
Да. И в наличии уже нет. А на английском я читаю так себе. Да ладно, кого я обманываю, вообще почти не читаю(


Stanislav [1 day ago]
Не надо экономить на такие вещи, месяц пиво не попей. Кому нужно, тот найдет.


Alexey_P [1 day ago]
https://www.labirint.ru/books/596462/
пишут "на складе"
Labirint.RU
Java Persistence API и Hibernate
Java Persistence - механизм, помогающий обеспечить сохранность данных после завершения программы, что является главной чертой современных приложений. Hibernate - наиболее популярный инструмент Java для работы с базами данных, предоставляющим...
 


Alexey_P [1 day ago]
а Яндекс сообщил, что здесь сильно дешевле
https://www.combook.ru/product/11821227/?_openstat=bWFya2V0LnlhbmRleC5ydTvQmtC40L3QsyDQky4sINCR0LDRg9GN0YAg0JouICJKYXZhIFBlcnNpc3RlbmNlIEFQSSDQuCBIaWJlcm5hdGUiO3cyaENsSVdJODA0Y3FjdGp1Um9zNnc7&frommarket=http%3A%2F%2Fmarket.yandex.ru%2Fpartner&ymclid=326342339736131652000001
combook.ru
Java Persistence API и Hibernate
Java Persistence – механизм, помогающий обеспечить сохранность данных после завершения программы, что является главной чертой современных приложений. Hibernate – наиболее популярный инструмент Java дл... (16 kB)


Alexey_P [1 day ago]
и это не месяц пива, а разочек)

Maksim K [1 day ago]
я и так пиво за последний год пару раз пил

Maksim K [1 day ago]
куда уж больше экономить)

Victor [24 hours ago]
попробуй на торрентах посмотри, я оттуда много брал, но я English стараюсь читать, русских нет.


Victor [24 hours ago]
хотя мое мнение доки по hibernate - очень даже хороши


realcorwin [22 hours ago]
Пересылка книг за границу обычно сильно дороже самих книг...


Merkulov [12:15 PM]
Spring Data JPA очень удобная штука, стоит просто правильно написать название метода и все работает!


shtramak [Today at 12:21 PM]
Как я понял из доклада Борисова «Spring Data, да та», этот фреймворк придуман в первую очередь, чтобы легко переключаться между разными базами, в том числе между видами баз (sql, nosql), чтобы определить, какая бд вам нужна. 

Но когда вы уже определись с базой и либой для работы с ней, без нативных запросов и реализаций не обойтись


1 reply
Merkulov [11 hours ago]
я к тому, что простые рутинные запросы делаются легко, понятно, что если делаешь что-то сложное то придется писать нативные запросы


shtramak [12:22 PM]
Потому что серебряной пули не существует


stea1th [Today at 12:53 PM]
ребята, а почему у меня так:



3 replies
sky [10 hours ago]
change profiles



Victor [9 hours ago]
maven не обновил. У меня только что покрасило в красный, я обновил зависимости, и все пропало. В общем у тебя нет зависимости этой


Grigory Kislin [4 hours ago]
выставь профиль справа вверху конфигурации- postgres либо hsqldb


stea1th [12:53 PM]
после патча 5.5

svis [2:34 PM]
У меня возник вопрос про Spring Cache - насколько часто он используется в реальный проектах на продакшн?
Или он как и Spring Data - используется на этапе разработки (тестирование, прототипирование)?


svis [Today at 2:36 PM]
А на продакшн юзают кэш в Хибернейт (edited)


4 replies
vch [9 hours ago]
А чем кэш Hibernate лучше чем Spring Cache?


svis [9 hours ago]
Просто лучше-хуже - это как то слишком общие рассуждения ИМХО:face_with_rolling_eyes: Лучше-хуже для чего? Если говорить об архитектуре - Spring это сборщик других фреймворков среди которых Hibernate. У Хибернейта тоже есть кэширование и оно более низкоуровневое. Использовать кэш спринга очевидно проще.  Но и в роликах Григорий не рекомендует использовать его для данных которые меняются “слишком часто“. Отсюда сразу опасение что там есть проблемы с производительностью ( скажу сразу - не измерял). Отсюда мой вопрос - как часто используется спринг кэш именно на продакшн


vch [9 hours ago]
Я использую, проблем не припомню. 
P.S. Ролик не смотрел


svis [9 hours ago]
OK, спасибо


Grigory Kislin [7:26 PM]
1.  Spring Data (если JPA на проекте) счас стандарт
2. про кэши- если он требуется- то используют. на каждом проекте разные( от спицифика зависит)
если данные часто меняются и их очень много - то НЕ используют (edited)

tema.emelyan [8:26 PM]
я такого никогда ещё не делал, но похоже можно спринг дата репозитории расширять, автоварить туда энтити менеджеры и в итоге довольно гибко получается (edited)
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.customize-base-repository
ну и само собой нативные query даже без всего этого можно делать если в аннотации `@Query(native = true, ...)` (edited)


stea1th [Today at 1:26 PM]
Screenshot_2.png



15 replies
e.pekhterev [5 hours ago]
посмотри что у тебя в Profiles


e.pekhterev [5 hours ago]
public static final String ACTIVE_DB = POSTGRES_DB;


e.pekhterev [5 hours ago]
а у тебя там явно не постгрес, а hsqldb

stea1th [5 hours ago]
Screenshot_3.png



stea1th [5 hours ago]
у нас же автоматом меняться должно


e.pekhterev [5 hours ago]
должно

stea1th [5 hours ago]
значит не тут затык

e.pekhterev [5 hours ago]
Reimport для мавен сделай


stea1th [5 hours ago]
сейчас

e.pekhterev [5 hours ago]
и clean, может починится


stea1th [5 hours ago]
делал


stea1th [5 hours ago]
урл странный стоит


stea1th [5 hours ago]
<beans profile="postgres">
       <context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>

       <bean id="dataSource"
             class="org.apache.tomcat.jdbc.pool.DataSource"
             p:driverClassName="org.postgresql.Driver"
             p:url="${database.url}"
             p:username="${database.username}"
             p:password="${database.password}"/>
   </beans>


e.pekhterev [5 hours ago]
а у тебя случаем не оба профиля в мавене выбраны?


stea1th [5 hours ago]
нет, верхний закоменчен


stea1th [1:26 PM]
почему ничего не работает? сделано все как в видео


Vitaly [Today at 1:32 PM]
написан драйвер от postgre, а url стоит на hsqldb (edited)


1 reply
stea1th [5 hours ago]
так я ничего не менял... это после патчей такое... я тоже это заметил


Vitaly [1:37 PM]
image.png 

так у тебя просто не переключился профиль на postgres
он потянул url из другого prop


stea1th [Today at 1:39 PM]
Screenshot_4.png



28 replies
e.pekhterev [5 hours ago]
этот и не будет никогда переключать, профиль переключается в другом месте.


e.pekhterev [5 hours ago]
1.png



stea1th [5 hours ago]
я похоже знаю где затык


stea1th [5 hours ago]
Screenshot_5.png
 


e.pekhterev [5 hours ago]
ты накатывал 5_5_profiles_connection_pool.patch????


e.pekhterev [5 hours ago]
у тебя уже не должно быть этой строчки вообще


e.pekhterev [5 hours ago]
к пятому занятию уже надо бы научиться патчи по порядку накатывать


stea1th [5 hours ago]
ты думаешь я совсем плохой?

stea1th [5 hours ago]
Screenshot_6.png



e.pekhterev [5 hours ago]
а чего не пушил после каждого патча


e.pekhterev [5 hours ago]
у тебя после 5_5 пачта должны были уйти эти строки


stea1th [5 hours ago]
не знаю... пушу обычно после всех... чтоб можно было откатиться назад


stea1th [5 hours ago]
почему не ушли/?


e.pekhterev [5 hours ago]
spring-db.xml
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:jdbc="http://www.springframework.org/schema/jdbc"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
    http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
    http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">
​
  <context:component-scan base-package="ru.javawebinar.**.repository.jpa"/>
​
  <jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
    <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
    <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
  </jdbc:initialize-database>
​
  <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"
     p:dataSource-ref="dataSource"
     p:packagesToScan="ru.javawebinar.**.model">
    <!--p:persistenceUnitName="persistenceUnit">-->
​
    <property name="jpaPropertyMap">
      <map>
        <entry key="#{T(org.hibernate.cfg.AvailableSettings).FORMAT_SQL}" value="${hibernate.format_sql}"/>
        <entry key="#{T(org.hibernate.cfg.AvailableSettings).USE_SQL_COMMENTS}"
            value="${hibernate.use_sql_comments}"/>
        <entry key="#{T(org.hibernate.cfg.AvailableSettings).JPA_PROXY_COMPLIANCE}" value="false"/>
        <!--<entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_AUTO}" value="${hibernate.hbm2ddl.auto}"/>-->
      </map>
    </property>
​
    <property name="jpaVendorAdapter">
      <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"
         p:showSql="${jpa.showSql}">
      </bean>
    </property>
  </bean>
​
  <tx:annotation-driven/>
​
  <!-- Transaction manager for a single JPA EntityManagerFactory (alternative to JTA) -->
  <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager"
     p:entityManagerFactory-ref="entityManagerFactory"/>
​
  <!--
    <context:component-scan base-package="ru.javawebinar.**.repository.jdbc"/>
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
      <constructor-arg ref="dataSource"/>
    </bean>
​
    <bean id="namedJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
      <constructor-arg ref="jdbcTemplate"/>
    </bean>
  -->
​
  <beans profile="hsqldb">
    <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>
​
    <!--no pooling-->
    <bean id="dataSource"
       class="org.springframework.jdbc.datasource.DriverManagerDataSource"
       p:driverClassName="org.hsqldb.jdbcDriver"
       p:url="${database.url}"
       p:username="${database.username}"
       p:password="${database.password}"/>
  </beans>
​
  <beans profile="postgres">
    <context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>
​
    <bean id="dataSource"
       class="org.apache.tomcat.jdbc.pool.DataSource"
       p:driverClassName="org.postgresql.Driver"
       p:url="${database.url}"
       p:username="${database.username}"
       p:password="${database.password}"/>
  </beans>
</beans>
Collapse


e.pekhterev [5 hours ago]
вот такой должен быть spring-db.xml после патча 5_6_profile_resolver.patch
в нём уже нет тех строк, что ты выше показал, они ушли после патча 5_5


stea1th [5 hours ago]
ну видишь, а они есть


e.pekhterev [5 hours ago]
ещё раз - некорректно накатаны патчи


stea1th [5 hours ago]
хорошо, что я делаю не так... я откачусь до начального состояния


e.pekhterev [5 hours ago]
чтоб я знал, я же сижу рядом, я накатываю патчи по порядку, и ещё ни разу проблем не было


e.pekhterev [5 hours ago]
тьфу тьфу тфьу

stea1th [5 hours ago]
не поверишь... делаю точно так же


e.pekhterev [5 hours ago]
конечно не поверю))) ты уже вродь не первый раз так попадаешь)


stea1th [5 hours ago]
первый


stea1th [5 hours ago]
ты считаешь, что я из разряда особо одаренных и патчи накатываю в рандомном порядке?


e.pekhterev [5 hours ago]
я не знаю, есть проблема, и вижу, что накат выполнен по каким то причинам некорректно, а кто насколько одарен - это не мне судить


stea1th [5 hours ago]
вот и мне интересно, отчего такое проявляется... есть ли момент, который я упускаю


stea1th [5 hours ago]
по идее пушить или не пушить дело каждого... главное по порядку делать Apply Patch


zippospb [2 hours ago]
Посмотри список файлов в каждом из патчей. Патч мог накатиться частично,  если были сделаны какие - то изменения в пропатчиваемом файле. Например, среди файлов в патче 5.5 нет spring-db.xml


stea1th [1:41 PM]
так что надо сделать?


stea1th [Today at 1:41 PM]
почему он не переключает?


38 replies
Grigory Kislin [5 hours ago]
В занятии есть как между hsqldb и postgres переключаться

stea1th [5 hours ago]
надо закоменчивать?


Gagarina6794 [5 hours ago]
Видео внимательно смотреть)


stea1th [5 hours ago]
так в чем затык то? я понимаю, что можно немножко похохотаться, но от этого яснее не станет


e.pekhterev [5 hours ago]
дело не в видео, тут проблема исключительно в накатке патчей


Stanislav [5 hours ago]
Пробовать самому разобраться (не такая уж и сложная проблема). На работе недельку потерпят (у меня там, тут, не работает) и досвиданья скажут.


stea1th [5 hours ago]
может мне код идеи поковырять и выяснить, почему она патчи криво накатывает?


stea1th [5 hours ago]
или я недостаточно прямо по левой кнопки мыши шлепаю на разделе Apply Patch?


Stanislav [5 hours ago]
99% накатывпет норм, а у вас нет...сделайте откат (вы в гите как ни как работаете) накатите заново...смысл ясен, есть вопросы мелочи которые обязан программист сам разбирать, а не дергать постояно того за кем закреплен, а есть реальные серьезные вопросы.


stea1th [5 hours ago]
может дело в версии интелидж? может в самом патче?


stea1th [5 hours ago]
просто что можно сделать не так, накатывая патч?


stea1th [5 hours ago]
может это баг новой версии идеи?


stea1th [5 hours ago]
почему запуская патч, я не получаю уведомления, что что то пошло не так?


stea1th [5 hours ago]
Screenshot_6.png



stea1th [5 hours ago]
даже здесь видно, что spring_db не обновился


stea1th [5 hours ago]
а я пушкин знать что должно вообще было обновиться?


stea1th [5 hours ago]
по большому счету это вопрос к @Grigory Kislin


Gagarina6794 [5 hours ago]
В каждом патче можно даже вручную зайти и посмотреть что меняется


stea1th [5 hours ago]
хорошо, может тогда вы скажете, почему должно меняться, не меняется и об этом не пишется?


Stanislav [5 hours ago]
Ты не Пушкин, ты будующий программист (наверно), любой патч открывается ( хоть блокнотом) и смотрится что в патче.


stea1th [5 hours ago]
вы каждый патч просматриваете ?


Stanislav [5 hours ago]
Да и не просто просматриваю, а вдумчиво и читаю что изменилось (история проекта)


stea1th [5 hours ago]
но после того, как его установили


stea1th [5 hours ago]
и я просматриваю и пытаюсь понять что и как


Stanislav [5 hours ago]
И если с чем то не согласен лезу в гугл и ищу мнения людей


stea1th [5 hours ago]
но я не исхожу из того, что половина в патче просто не поставилась

stea1th [5 hours ago]
видимо вы более продвинуты в этом плане, чем я


Stanislav [5 hours ago]
Нет, просто считаю что профессия программист означает в начале самому разобраться н-ное время, а не сразу дергать людей или задавать на стоковерфлоу вопросы (как у нас уже был какой то тут умник, по jsp на стоковерфлоу вопрос накатал).


stea1th [5 hours ago]
хорошо, можете ли вы ответить на вопрос, почему патч накатывается, а какие то файлы не меняются и об этом не появляется предупреждение?


stea1th [5 hours ago]
вот чисто как программист недопрограммисту


Stanislav [5 hours ago]
С ходу ответить не могу ибо нужен ваш гит, делать форк, разбираться, а мне влом (у самого дел много). Я бы сделал откат на тот коммит который норм и до патчил заново


stea1th [5 hours ago]
а почему такое вообще возможно?


Victor [4 hours ago]
Попробуй проверять галочки на классах когда apply patch. Иногда галочки слетают и не все классы обновляются. У меня так было (кривые руки)


stea1th [4 hours ago]
Все галочки стоят


Victor [4 hours ago]
сейчас уже работает все?


stea1th [4 hours ago]
Не совсем... Короче появляется типа красного поля, что не идея не может поставить... Жмёшь на Apply, и что то ставится, что то нет

stea1th [4 hours ago]
Не знаю как эту проблему решить

Gagarina6794 [3 hours ago]
сделай откат на начало урока до 5.1  и накати заново


Gagarina6794 [3:22 PM]
Вопрос, почему мы здесь не проверяем getCache на null? @Before
   public void setUp() throws Exception {
       cacheManager.getCache("users").clear();
   }  идея об этом предупреждает


Maksim K [Today at 3:50 PM]
Товарищи, вопрос по патчу 5_7. У меня почему то не хочет в помнике применять строку  `<spring-data-jpa.version>2.0.8.RELEASE</spring-data-jpa.version>`. Пишет not applied. Сам патч ставится, но в помник эта строчка не добавляется. ЕЕ просто потом вручную добавить или как?


11 replies
Victor [3 hours ago]
```<spring.version>5.0.7.RELEASE</spring.version>
        <spring-data-jpa.version>2.0.8.RELEASE</spring-data-jpa.version>
        <tomcat.version>8.5.31</tomcat.version>```
у меня так после 7ого патча


Maksim K [3 hours ago]
вот у меня вот эта строка  `<spring-data-jpa.version>2.0.8.RELEASE</spring-data-jpa.version>` не хочет применяться почему-то. в итоге я патч накатил и эту строку вручную добавил. вроде все норм. правда тесты не идут. наверно так надо. еще не дошел до этого


Victor [3 hours ago]
нет, тесты должны идти


Victor [3 hours ago]
но там по видео правильно нужно сделать: нажать clean, выбрать базу в maven и сделать import


Maksim K [3 hours ago]
ща как раз видео смотрю) потом поглядим)

Maksim K [2 hours ago]
все я понял) че ты меня обманываешь?)) не должны тесты проходить. мы же типа ща тестим dataJpa. а там у нас еще никакой реализации. ну юзер тестится, а еда нет


Victor [2 hours ago]
да проходят. Ну user тесты конечно, ане meal.


Victor [2 hours ago]
Я же у себя запускаю

Maksim K [2 hours ago]
я просто тест еды запускал)

Victor [2 hours ago]
хотел meal тест запустить? Крутяк )))

Maksim K [2 hours ago]
ну просто я только патч применил и не видел что там поменялся  <context:component-scan>. попробовал запустить и фиг там) если его закомментить, а наш старый раскомментить, то все работает))


Join_Selectovich [Today at 4:30 PM]
Поясните пожалуйста фразу 
_*При загрузке Meal, Hibernate на основе поля meal.user_id делает ленивую прокcи к User, у которой нет ничего, кроме id.*_
Не могу уловить суть проксирования в чем тут заключается (edited)


10 replies
Join_Selectovich [2 hours ago]
Это получается что создается урезанная  сущность юзер у которой все кроме id пустое? (edited)


shtramak [2 hours ago]
Вместо реального объекта user получается получается прокси


Join_Selectovich [2 hours ago]
Что значит прокси, это сущность в данном случае?


Victor [2 hours ago]
тоесть над объектом user делается обертка в которой есть id. Вместо остальных полей метод. И если обратиться к полю, то будет выполнен метод и поле будет вытянуто из базы

Join_Selectovich [2 hours ago]
наверное обертка над классом User

shtramak [2 hours ago]
Там заморочено конечн)



shtramak [2 hours ago]
Ну это сделано, чтобы экономить время и ресурсы и не тянуть все лишние данные из базы


shtramak [2 hours ago]
Иначе ставится fetchtype.eager


tema.emelyan [2 hours ago]
https://stackoverflow.com/questions/20988626/what-is-proxy-in-the-context-of-load-method-of-hibernate
https://stackoverflow.com/questions/2227836/what-is-the-meaning-of-using-proxy-dynamic-proxy-in-spring-framework (edited)



Join_Selectovich [2 hours ago]
C eager/lazy понятно, не понятно как оно устроено


Join_Selectovich [4:32 PM]
Это в пояснениях перед строкой 
*Apply 5_3_HW4_optional.patch*

shtramak [4:34 PM]
Так у нас же fetch.lazy


stea1th [Today at 4:37 PM]
как откатить патчи до начала пятого урока?


9 replies
Gagarina6794 [2 hours ago]
Сделать ресет ветки на последний коммит


stea1th [2 hours ago]
где он делается


stea1th [2 hours ago]
?


Gagarina6794 [2 hours ago]
В локал чейндж на ветке мастера на последнем коммите правая кнопка мыши и в меню обновление ветки к такому то коммиту


stea1th [2 hours ago]
скрин можешь сделать?


Gagarina6794 [2 hours ago]
Сейчас не могу, немного позже

Gagarina6794 [2 hours ago]
Новый точечный рисунок.bmp



Gagarina6794 [2 hours ago]
versionControl-> log


Gagarina6794 [2 hours ago]
на последнем комите


stea1th [4:37 PM]
так чтобы следов не осталось ... я их не коммитил

Merkulov [4:48 PM]
Для достать по id пользователя вместе с его едой я в User добавил List<Meal> meals 
что-то этого не замечаю после патчев, у всех так?


e.pekhterev [Yesterday at 6:58 PM]
Парни/девушки, какой паттерн проектирования применён в классе DataJpaUserRepositoryImpl?:
- декоратор;
- адаптер;
- другой;
- никакой. (edited)


12 replies
Gagarina6794 [21 hours ago]
CrudUserRepository -адаптер через наследование, и плюс декоратор, так как добавляет свои методы... расширяя входящий интерфейс (edited)


Gagarina6794 [21 hours ago]
А сам JpaRepository какой мутант)) там и декоратор тебе и адаптер) если просмотреть всю историю его наследования...очень интересно (edited)


Gagarina6794 [21 hours ago]
этому паттерну дадим имя Григорий))  (адаптер + декоратор) (edited)
 


Gagarina6794 [20 hours ago]
Но JpaRepository как бы подразумевает написание нами некоторых дополнительных методов по "заклинанию", и он их может запросто сам реализовать... Он упрощает сам процесс декорирования, о как!


Gagarina6794 [20 hours ago]
Но применения к нему адаптера он никак не ожидал))


Grigory Kislin [2 hours ago]
вопрос интересный:)
я бы назвал это композицией с делегированием
если бы стояла бизнес задача преобразовать UserRepository в CrudUserRepository то это был бы адаптер ( у нас нет бизнес задачи, CrudUserRepository  - внутреняя фича нашей реализации data-jpa)
делегат интерфейсов не меняет, а прокси похож на делегата, но служит невной подмены (часто прямо в рантайм)
https://refactoring.guru/ru/design-patterns
refactoring.guru
Паттерны/шаблоны проектирования (59 kB)


Grigory Kislin [1 hour ago]
2. девушки тут тоже присутствуют:)


e.pekhterev [1 hour ago]
@Grigory Kislin апдатед) (edited)


Grigory Kislin [1 hour ago]
:slightly_smiling_face: я тоже в урок добавил



e.pekhterev [1 hour ago]
@Grigory Kislin на самом деле очень приятно, когда начинаешь такие вещи замечать, код и его назначение становится более понятными, надо поучить паттерны конечно)


Grigory Kislin [1 hour ago]
согласен, приятно. мне на собеседовании в мой код по описанию спросили про паттерн, я тогда не смог назвать commander. а bridge у себя в коде сам распознал:)


e.pekhterev [1 hour ago]
@Grigory Kislin вот я как раз про собеседование и подумал - что вполне возможны подобные вопросы (edited)


tema.emelyan [Yesterday at 7:14 PM]
я думаю фасад


15 replies
e.pekhterev [22 hours ago]
а чем тебе не адаптер?


e.pekhterev [22 hours ago]
в плане адаптера - мы полностью выполняем условия.
мы полностью адаптируем CrudUserRepository под UserRepository.
т.е. объект CrudUserRepository через адаптер DataJpaUserRepositoryImpl реализует все методы интерфейса  UserRepository

не согласен?


tema.emelyan [22 hours ago]
да согласен, не прав


tema.emelyan [22 hours ago]
адаптер


e.pekhterev [22 hours ago]
но как бы почему не декоратор?


e.pekhterev [22 hours ago]
Декоратор — это структурный паттерн проектирования, который позволяет динамически добавлять объектам новую функциональность, оборачивая их в полезные «обёртки».


tema.emelyan [22 hours ago]
ну декоратор это когда прокси наверное (edited)


e.pekhterev [22 hours ago]
т.е. в чём дилема - с одной стороны мы декорируем (например меняем поведение метода delete - меняем функциональность), с другой - адапитируем CrudUserRepository под UserRepository
видимо декоратор идет по любому как часть реализации адаптера


e.pekhterev [22 hours ago]
короче задал вопрос, и нашел ответ во время спора))))


tema.emelyan [22 hours ago]
ну не, мы же динамически ничего не меняем


tema.emelyan [22 hours ago]
мне кажется декоратор - это например логгинг через аоп. например у нас был класс, мы через аоп добавляем логгирование, но специально новый класс не создаем для этого


tema.emelyan [22 hours ago]
а здесь создаём новый класс и работаем с новым классом уже


e.pekhterev [22 hours ago]
в декораторе тоже создается новый класс


e.pekhterev [22 hours ago]
надо вообще конечно почитать поподробнее)


Gagarina6794 [21 hours ago]
CrudUserRepository, это таки адаптер, есть адаптеры которые реализуются либо через наследование либо через композицию, здесь через наследование, суть в том что мы таким образом переопределяем методы базового интерфейса(класса) с нужным более широким как правило функционалом ну и плюс декоратор.. (edited)


Victor [10:35 PM]
@Grigory Kislin Тут ошибка? лишнее слово задать...
>2.1: Профили выбора DB (postgres/hsqldb) и реализации репозитория (jdbc/datajpa/jpa) независимы друг от друга и при запуске `задать` приложения (тестов) нужно задать тот и другой.


Gagarina6794 [Today at 7:20 AM]
2: В реализациях JdbcMealRepository код не должен дублироваться.  -  Jdbc или Jpa?


1 reply
sky [10 hours ago]
Jdbc


Andrey [Today at 2:11 PM]
5: Разделить JdbcMealRepositoryImpl для HSQLDB (она не умеет работать с Java8 Time API) и Postgres через @Profile (для Postgres оставить LocalDateTime). 
Может просто версию поднять hsqldb?) он уже научился это делать



8 replies
Merkulov [3 hours ago]
я так понимаю нужно через профили делать, чтобы потренероваться



Merkulov [3 hours ago]
только не совсем понятно как, поидеи должно быть что-то типа такого: есть два бина, которые инджектятся в зависимости от актвного профиля, и должна быть одна ссылка в jdbcMealRepo.. которая должна вставлять правильную конвертацию локалдэйт, тока пока мне не понятно как это реализовать, нужен какой-то общий интерфейс чтобы подставлял динамическую конвертацияю, хотя может и не так все должно быть, пока не знаю


Merkulov [3 hours ago]
какие есть соображения ?

Andrey [3 hours ago]
да как-то сложно получается, hsqldb кушает Timestamp, postgres -обычный LocalDate..


Andrey [3 hours ago]
Т.е. нужен интерфейс с дженериком, который преобразует LocalDateTime либо в LocalDateTime - возвращает его же, либо в Timestamp - Timestamp.valueOf



Andrey [3 hours ago]
две реализации этого интерфейса - для разных профилей, и инжект этого интерфейса в JdbcRepository и использование его там при работе с датами (edited)

Andrey [2 hours ago]
Но выглядит это как изврат какой-то)) для учебных целей только если пойдет, может как-то получше можно?


Grigory Kislin [2 hours ago]
попробуй получше:)


Merkulov [Today at 4:12 PM]
почему при обращении к lazy полю через просто гет вылетает ошибка инициализации типа нет сессии, а если сделать sout(meal.getUser) то все работает?)


3 replies
shtramak [1 hour ago]
Простыми словами, при lazy, поле user заполняется прокси, у которого есть только id. в sout ты просто вызываешь toString, который естественно работает. А вот работа с самим прокси требует сессии.

Ща попробую найти норм ссылку, но суть в том, что эти прокси очень капризные и вне сессии не работают И насколько мне не изменяет память, не будут работать с сессией, в которой они не были созданы


shtramak [39 minutes ago]
чет норм ссылок не нашел, но вроде эти ничего по решению проблемы https://www.javacodegeeks.com/2012/07/four-solutions-to-lazyinitializationexc_05.html (edited)


shtramak [39 minutes ago]
https://www.javacodegeeks.com/2012/07/four-solutions-to-lazyinitializationexc.html (edited)


shtramak [4:17 PM]
выше было обсуждение https://topjava14.slack.com/archives/CBX6WTJQ2/p1532785262000011?thread_ts=1532784621.000009&cid=CBX6WTJQ2
tema.emelyan
https://stackoverflow.com/questions/20988626/what-is-proxy-in-the-context-of-load-method-of-hibernate
https://stackoverflow.com/questions/2227836/what-is-the-meaning-of-using-proxy-dynamic-proxy-in-spring-framework
From a thread in #hw5Yesterday at 4:41 PM


Alexey_P [Today at 4:44 PM]
Помогите разобраться. Меня смущает в задании "3.1 сделать один базовый класс для MealServiceTest и UserServiceTest." Понятно, что в базовый класс какой-нибудь BaseEntityTest можно вынести логгер, StringBuilder для StopWacth и т.д. Но методы вынести не получится. Вернее, можно, но придется плясать с Reflection. Стоит ли овчинка выделки или я что-то не понимаю? Или есть простое и эффективное решение?


16 replies
shtramak [1 hour ago]
а почему тебе понадобится рефлекшн? У тебя в базовом тесте будет поле интерфейса тестируемого класса. К этому интерфейсу ты будешь обращаться и вызывать его методы


shtramak [1 hour ago]
При запуске тестов, junit сам поймет, что класс теста абстрактный и запустит его наследников


Alexey_P [38 minutes ago]
методы тестируемых классов неодинаковы, например, по набору параметров, используют ассерты из разных классов и т.д. Как это обходить?


Alexey_P [33 minutes ago]
если класс теста абсрактный, то в наследниках мы реализовываем все методы теста. И тогда возвращаемся к вопросу - стоит ли овчинка выделки. Хотелось бы приенить шаблонный метод, чтобы реализацию чего-нибудь вынести в суперкласс


shtramak [32 minutes ago]
Хм, можно интерпретировать задание двумя способами
1. один базовый класс для meal и user
2. один базовый класс для всех mealrepo и один базовый класс для всех userrepo

И я думаю по логике второе


shtramak [32 minutes ago]
Сделать тесты всех реализаций (jdbc, jpa, datajpa) через наследование (без дублирования)


Alexey_P [27 minutes ago]
Наверное, это задача связана с "2: Разделить реализации Repository по профилям Spring: jdbc, jpa, datajpa", которую я пока не знаю как делать)


sky [27 minutes ago]
3 абстрактных - 1 общий, 1 для милов, 1 для юзеров, и 6 их реализаций


Alexey_P [26 minutes ago]
по поводу интерпретации, там однозначно - "сделать один базовый класс для MealServiceTest и UserServiceTest"


Grigory Kislin [23 minutes ago]
делать просто и красиво. лишнего ничего не надо


Grigory Kislin [22 minutes ago]
рекомендую этот принцип везде где можно, не только тут

Alexey_P [22 minutes ago]
а что за 6 реализации? Тесты сервиса вроде никак не меняются, могут меняться профайлы Spring'а. кроче, я запутался).


sky [20 minutes ago]
jdbc, jpa, datajpa для милов и те же для юзеров - итого 6. Т.е. у каждой реализации @ActiveProfiles свой. При этом сама реализация пустая. Как по другому запустить каждый тест, для каждой из технологий, я придумать не смог, но Григорий намекнул, что вроде как сие не есть гуд. (edited)


Alexey_P [12 minutes ago]
sky, еще раз напишу - тесты у нас никак не меняются при тестировании разных репозитариев, должны просто переключаться профили для разных реализации репозитариев, как в случае с ВИ резольвером.   Так какие 6 разных реализаций? Или я неправильно понимаю?


Alexey_P [11 minutes ago]
а, ну вот видишь, мы об одном говорим

sky [2 minutes ago]
Может конечно тесты просто должны выполнятся для одного конкретного активного профиля, и тогда можно было бы ограничится 1 абстрактным общим классом и 2умя реализациями для милов и юзеров (т.е. что то типа ActiveApiProfileResolver), но я задание понял, что сделать надо сразу для всех


Merkulov [5:26 PM]
Кто сталкивался с циклической зависимостью полей у User' а при сравнение ожидаемого значения с фактическим в тестах?


Join_Selectovich [Jul 29th at 6:34 PM]
Помогите разобраться. Как так получилось что в класс DataJpaUserRepositoryImpl в видео был проинжектирован интерфейс, а не экземпляр какого-либо класса
  @Autowired
   private CrudUserRepository crudRepository;
и это все рабтает?! как так? :frowning: (edited)


19 replies
sky [3 days ago]
Когда передается интерфес или абстрактный класс, умный спринг смотрит, есть ли у него реализации с нужной аннотацией, и если есть, и она одна, то ее он и впрыснет (если несколько, и нет разделения с помощью профилей или еще чего, то эксепшн) (edited)


e.pekhterev [3 days ago]
в видео Григорий как раз про это рассказывал - чёрная магия


Join_Selectovich [3 days ago]
охренеть...

e.pekhterev [3 days ago]
он наследуюется от JpaRepository, а при запуске там всё инжектится - так работает фреймворат spring-data-jpa


Merkulov [3 days ago]
https://www.youtube.com/watch?v=nwM7A4TwU3M&t=817s
YouTube JUG .ru
Евгений Борисов — Spring Data? Да, та!
 


Merkulov [3 days ago]
Спринг налету создает имплементацию интерфейса

Join_Selectovich [3 days ago]
@sky так у нас же в проекте нигде нет реализации этого инерфейса!? :astonished: CrudMealRepository (edited)

e.pekhterev [3 days ago]
фреймворк реализует


e.pekhterev [3 days ago]
так же как и метод  User getByEmail(String email);


sky [3 days ago]
есть SimpleJpaRepository


Join_Selectovich [3 days ago]
Уже несколько раз пересматриваю видео, что-то эта тема очень тяжело дается... :disappointed_relieved:


realcorwin [3 days ago]
самый прекрасный раздел в спринге. все бы разделы так легко и удобно работали :slightly_smiling_face:


Join_Selectovich [3 days ago]
я так понимаю что в spring-db.xml тег 
_<jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>_
как раз просит у спринга инстансыировать в ioc-контейнере всех наследников класса JpaRepository. Так или нет? (edited)


e.pekhterev [3 days ago]
нет, тут мы получаем только классы, отмеченные аннотацией @Repository (edited)


e.pekhterev [3 days ago]
а они в свою очередь уже автоваярят наши крудИнтерфейсы, которые наследуются от JpaRepository, который в свою очередь не класс, а интерфейс тоже)))) (edited)

Join_Selectovich [3 days ago]
:exploding_head:


e.pekhterev [3 days ago]
я ж говорю - это всё магия)))


e.pekhterev [3 days ago]
черная

Grigory Kislin [1 day ago]
1. `<jpa:repositories base-package=`  jn spring-data-jpa сканирует в заданном пакете все имплементации `JpaRepository` и делает из них классы, наследуемые от `SimpleJpaRepository`. можно в дебаге посмотреть, что там в результате
2. далее все стандартно


matrocob [Jul 29th at 6:47 PM]
ребят подскажите или дайте пожалуйста наводку, как реализовать профайл в spring-db


17 replies
matrocob [3 days ago]
когда пытаюсь перенести
<context:component-scan base-package="ru.javawebinar.**.repository.datajpa"/>
   <jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>
в профайл datajpa начинается в тестах сыпаться ошибки..
Выбрать реализацию пула коннектов может надо добавить? (edited)


sky [3 days ago]
а ты в тестах выбираешь профиль? Чтобы тесты не сыпались надо выполнить сначала 3е задание (edited)


matrocob [3 days ago]
так в классах тестов и так стоит активпрофиль для выбора бд... ладно, попробую третье задание сделать может разберусь...


sky [3 days ago]
вот-вот  - для бд, а для repository-implementation там активпрофиль как раз и не стоит


matrocob [3 days ago]
смотри, но по сути сам профиль
  <beans profile="datajpa">
       <context:component-scan base-package="ru.javawebinar.**.repository.datajpa"/>
       <jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>
   </beans>
должен итак работать для теста с datajpa.. Я его выбираю же в spring-db и он у меня активный становится (edited)


sky [3 days ago]
сверху через Change profiles выбираешь? галочку ставишь? (edited)


matrocob [3 days ago]
ну да


matrocob [3 days ago]
Безымянный.jpg



matrocob [3 days ago]
но... ошибка тест ложится после того, как
 <context:component-scan base-package="ru.javawebinar.**.repository.datajpa"/>
       <jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>
этот код вырезаю и вставляю в профайл datajpa


sky [3 days ago]
4 видео из урока с 9 минуты смотри


sky [3 days ago]
а лучше все видео смотри целиком

matrocob [3 days ago]
сейчас гляну, спасибо вам большое) та уже смотрел раза 3))



matrocob [3 days ago]
Все, додумался.... Я так понимаю... нельзя ставить две аннотации ActiveProfiles над классом, тогда как запустить чтобы и бд подцепить и реализацию к примеру jpa? использовать { } ?


matrocob [3 days ago]
@ActiveProfiles({ActiveDbProfileResolver.class, DATAJPA})
как-то так?

sky [3 days ago]
подсказка 10 в конце урока

matrocob [3 days ago]
спасибо!)



matrocob [3 days ago]
лучший просто))


e.pekhterev [Jul 29th at 6:54 PM]
На этой лекции была ссылка на статью о @Transactional ( https://www.ibm.com/developerworks/ru/library/j-ts1/ )
мол @Transactional(readOnly = true) нам ничего не гарантирует. И в нашем проекте, если эта аннотация стоит на классе и удалить @Transactional c методов delete и save - то всё прекрасно рабоет. Так зачем мы тогда упорно пишем аннотации @Transactional  для этих методов?  
Вопрос даже немного о другом, пусть мы даём аннотации @Transactional  для методов save и delete, но как нам обеспечить именно ридОнли транзакционность для других методов?
ibm.com
Распространенные ошибки
В этой статье Марк Ричардс описывает распространенные подводные камни, которые могут привести к потере согласованности. Они объясняются на примерах, взятых из инфраструктуры Spring Framework и спецификации EJB (Enterprise JavaBeans) 3.0.
 
(edited)


37 replies
Victor [3 days ago]
вот только что попробовал не поставить на delete @Transactional когда на классе @Transactional( readOnly = true), и сразу вылетел Exception. Поругалось что я пытаюсь внести изменения, когда стоит read only.



Victor [3 days ago]
получается если поставил на классе, то методы без аннотации обеспечены read only транзакционностью

e.pekhterev [3 days ago]
да, действительно

e.pekhterev [3 days ago]
проверял только для метода save - он отлично без трансакции работает, хотя по хорошему она ему нужна (edited)


e.pekhterev [3 days ago]
всё, разобрался, мы вызываем у круда save, который на самом деле вызывается у SimpleJpaRepository, а там этот мето как раз @Transactional, поэтому и эксепшина нет (edited)


Johann [3 days ago]
в CrudMealRepository в методе deleteByIdAndUser_Id  на тесте "delete" будет вылетать javax.persistence.TransactionRequiredException, если не отметить его как  @Transactional


Victor [3 days ago]
@Johann deleteByIdAndUser_Id - cделал без @Query ?

Johann [3 days ago]
без, там же готовая белая магия, главное правильный порядок слов в заклинании

Victor [3 days ago]
блиин думал точно так же попробовать, но решали, что не получиться )))

Johann [3 days ago]
idea поможет, главное начать с правильного глагогла)


e.pekhterev [3 days ago]
как без квери? намже нужно юзер_id ещё привязать

Victor [3 days ago]
Работает )) спасибо за поджопник ))


e.pekhterev [3 days ago]
с ЮзерId?

Victor [3 days ago]
почитай https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation


Victor [3 days ago]
я решил что не будет, а оказалось магия 80 лвл там )))


e.pekhterev [3 days ago]
черт, не прочитал, но сделал и заработало)))) (изи, уже так делал, но видимо транзакшинел забыл) (edited)

Victor [3 days ago]
фишка номер 2:
так тоже работает `deleteByIdAndUserId`

e.pekhterev [3 days ago]
ну я так и сделал

Victor [3 days ago]
я думал что _ обязательно типа вместо точки


e.pekhterev [3 days ago]
а ты до этого живого юзера передавал))?


Victor [3 days ago]
deleteByIdAndUser_Id - думал так ворожить нужно


e.pekhterev [3 days ago]
нет, так не нужно


e.pekhterev [3 days ago]
нужно по названию поля в модели корректно в кэмелКейсе писать

e.pekhterev [3 days ago]
а я тут блин квери пишу как лузер

e.pekhterev [3 days ago]
другое дело, что все эти deleteByIdAndUser_Id  немного дороже, чем аналогичные методы с квери, потому как в первом случае фреймворк расшифровывает название методы и сам варганит запрос, а во втором - мы ему даём уже готовый запрос, т.е. первый вариант по идее чутка дороже.


Victor [3 days ago]
это ж всё компилируется. Раз собрало и юзает. Думаю разница нет. Наверное.


e.pekhterev [3 days ago]
возможно

e.pekhterev [3 days ago]
надо остальные методы попробовать замучить



e.pekhterev [3 days ago]
а то я всё в запросах делал


Victor [3 days ago]
буду комментить query методы, чтоб опыт не пропадал за зря...


e.pekhterev [3 days ago]
да, я тоже оставлю, но Катерина всяко за это наругает


Victor [3 days ago]
я уже приготовился ))))

e.pekhterev [3 days ago]
тапкой по лицу натучит)))

e.pekhterev [3 days ago]
со словами - доколе))))

Johann [3 days ago]
deleteByIdAndUser_ такая конструкция сразу после подчеркивания в выпадающем меню выдает все поля юзера в качестве опции, так чуть поудобнее кмк



Victor [3 days ago]
getbetween через магию - это нечто ))))))


e.pekhterev [3 days ago]
да оно всё там выглядит магией до неприличия.


Gagarina6794 [Jul 29th at 9:16 PM]
@Autowired
   private CrudUserRepository crudRepository;  Идея говорит аннотация здесь не требуется, без нее все работает


15 replies
sky [3 days ago]
у меня не сработало. Вообще вроде как сейчас становится принятым делать эти переменные финал, и делать конструктор. И вот тогда все заработает, причем конструктор без аннотации автовайред. Но по мне, какая-то неправильная практика, ведь просто переменная интерфейса с аннотацией и более читаемая, и нет бойлеркодного конструктора


Gagarina6794 [3 days ago]
да, так можно  и запутаться, на поля читала редко ставят @Autowired и не рекомендуют

sky [3 days ago]
Вот по этому поводу неплохо было бы услышать мнение Григория


Gagarina6794 [3 days ago]
он уже где-то пару раз обьяснял почему он так сделал, вот забыла ...


sky [3 days ago]
вот например что люди пишут по поводу автовайреда над сеттером против поля 
"this would give me flexibility later on to move away from Spring"
Но кто же в здравом уме захочет со спринга слезать..


Gagarina6794 [3 days ago]
вот пока не знаю, может чего другого юзают паралельно

Gagarina6794 [3 days ago]
Spring я так поняла не самый хороший фреймворк


sky [3 days ago]
Этож вроде про Hibernate. Альтернатива спринг даже не гуглится (по крайней мере с ходу) там только Java EE


Gagarina6794 [3 days ago]
https://habr.com/post/334118/
Хабр
Почему я ненавижу Spring
В начале своей карьеры я реально влюбился в Spring. Я так долго ждал его. Я использовал его во всех своих проектах. Вдобавок мне даже удалось впихнуть туда кучу... (50 kB)


Gagarina6794 [3 days ago]
но тут вроде автор просто неопытный

Gagarina6794 [3 days ago]
нашла кое-что https://www.dailyrazor.com/blog/best-java-web-frameworks/
DailyRazor.com
Best Java Web Frameworks for 2018 - Spring MVC, Struts, Vaadin, etc.
Listing of the top 10 Best Java Web Frameworks for easy and rapid Java web application development. Find the best Java web framework for your project needs.
Jan 1st at 3:30 PM
 


sky [3 days ago]
Struts ? https://ru.stackoverflow.com/questions/412706/%D0%A7%D1%82%D0%BE-%D0%B2%D1%8B%D0%B1%D1%80%D0%B0%D1%82%D1%8C-%D0%B8%D0%B7-java-%D1%84%D1%80%D0%B5%D0%B9%D0%BC%D0%B2%D0%BE%D1%80%D0%BA%D0%BE%D0%B2-%D0%B4%D0%BB%D1%8F-%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D0%B0-%D0%BA%D0%BE%D0%BB%D0%BB%D0%B5%D0%BA%D1%86%D0%B8%D0%B8-spring-mvc-struts-mojarr (edited)


Gagarina6794 [3 days ago]
мы просто пока мало видели чего из жизни ит, думаю Spring промышленный стандарт, но людям под разные задачи может что и другое требуется

Grigory Kislin [1 day ago]
насчет @Autowired на поля- я часто встречал, несмотря на то, что не рекомендуют, потому что короче
с lombok коротко получается с `@RequiredArgsConstructor`, спринг автоматически в конструктор инжектит


Grigory Kislin [1 day ago]
10 фреймворков, Егором Бугаенко и прочие ругатели ООП, Спринг, Хибернайт вам счас срорее вредны


Join_Selectovich [Jul 29th at 9:26 PM]
Кто может объяснить каким чудом в видео *6. Spring Data JPA*  на 24:35 вдруг появились методы в интерфейсе ProxyUserRepository, вроде HotKey никаких не нажималось ?!?! (edited)


5 replies
sky [3 days ago]
Я думаю нажимался HotKey ctrl+v



e.pekhterev [3 days ago]
по любому


Join_Selectovich [3 days ago]
обычно все нажатия выводятся на экран, тут как-то раз и магия


Merkulov [3 days ago]
видео наврное монтированное


Join_Selectovich [3 days ago]
:male_mage:  похоже да...


Merkulov [Jul 29th at 9:33 PM]
Ребята, нужна помощь, который час бьюсь, тест все не проходит, достаю User и вместе с ним его еду и получатся ожидаемое значения пользователь и его еда, а сервис тащит за собой еще и пользователя этой еды, получается циклическая зависимость, куда копать?


7 replies
vch [3 days ago]
Т.е. при запросе из базы юзера ты получаешь List<Meal> ? А зачем? Юзер без еды обычно используется.


Merkulov [3 days ago]
это из optional 7.1: достать по id пользователя вместе с его едой


sky [3 days ago]
Я по разному делал, там где просто в транзакции обращался к полю meals - так же циклично все, а где через query сделал (юзера доставал, left join) там все ок. Думаю что еще есть вариант, просто вытащить оба элемента и засетить 1 в другой, думаю цикличности тоже не будет


Merkulov [3 days ago]
ок, тоже попробую через Query

Nikolay [2 days ago]
сделай lazy инициализацию у пользователя еды, и у еды в пользователе тоже можно сделать, так как смысла тащить всегда еду  нет (edited)



Merkulov [2 days ago]
даже если сделать lazy все равно остается циклическая зависимость и через LeftJoin и это вроде как логично связь то  у нас двунаправленная, встает вопрос так как корректно сравнить эти объекты в тестах


Grigory Kislin [1 day ago]
по умолчанию должно быть lazy. с ним не зацикливается


Merkulov [9:48 PM]
2: В реализациях JdbcMealRepository код не должен дублироваться. Если вы возвращаете тип Object, посмотрите в сторону дженериков.
про какие две реализации идет речь?


Merkulov [Jul 29th at 9:49 PM]
зачем там две реализации?


5 replies
sky [3 days ago]
для 2 db профилей


Merkulov [3 days ago]
зачем


Merkulov [3 days ago]
там ведь можно сделать просто два бина с одним интерфейсом и инжестить его и в зависимости от активного профиля будет конвертация которая нужна


Merkulov [3 days ago]
лично я так сделал. тогда значит не нужно делать два класса, это хорошо)


Grigory Kislin [1 day ago]
@Merkulov осталось дублирование кода в классах убрать


hav [Jul 30th at 10:18 AM]
6: В Data-Jpa метод для ссылки на entity (аналог em.getReference) : T getOne(ID id). Что-то я не понял этого пункта... Как в DataJpaMealRepositoryImpl получить ссылку на юзера?


3 replies
Alexander Pilipenko [2 days ago]
Заинжекти и CrudUserRepository вместе с CrudMealRepository (edited)


hav [2 days ago]
Такая мысль у меня была, но показалась не очень правильной.


Maksim K [2 days ago]
о. хороший вопрос. я вот тоже думал инжектить или как по-другому)


Alexander Pilipenko [10:20 AM]
Когда-то давно поднимался вопрос про optional = false

Сейчас опять столкнулся с этой опцией.
У меня было сделано так:
@ManyToOne(fetch = FetchType.LAZY)
   @JoinColumn(name = "user_id", nullable = false)
   @NotNull
   private User user;

При этом при выполнении:
@Override
   public List<Meal> getAll(int userId) {
       return crudMealRepository.findByUser_Id(SORT_DATE_TIME_DESC, userId);
   }

Генерируется следующий запрос:
10:06:24.618 INFO  o.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript:510 - Executed SQL script from class path resource [db/populateDB.sql] in 15 ms.
Hibernate:
   /* select
       generatedAlias0
   from
       Meal as generatedAlias0
   left join
       generatedAlias0.user as generatedAlias1
   where
       generatedAlias1.id=:param0
   order by
       generatedAlias0.dateTime desc */ select
           meal0_.id as id1_0_,
           meal0_.calories as calories2_0_,
           meal0_.date_time as date_tim3_0_,
           meal0_.description as descript4_0_,
           meal0_.user_id as user_id5_0_
       from
           meals meal0_
       left outer join
           users user1_
               on meal0_.user_id=user1_.id
       where
           user1_.id=?
       order by
           meal0_.date_time desc

Если в использовать 
@ManyToOne(fetch = FetchType.LAZY, optional = false)
   @JoinColumn(name = "user_id", nullable = false)
   @NotNull
   private User user;

То получим:
/* select
       generatedAlias0
   from
       Meal as generatedAlias0
   where
       generatedAlias0.user.id=:param0
   order by
       generatedAlias0.dateTime desc */ select
           meal0_.id as id1_0_,
           meal0_.calories as calories2_0_,
           meal0_.date_time as date_tim3_0_,
           meal0_.description as descript4_0_,
           meal0_.user_id as user_id5_0_
       from
           meals meal0_
       where
           meal0_.user_id=?
       order by
           meal0_.date_time desc (edited)


shtramak [2 days ago]
Не понятно, в чем вопрос


shtramak [2 days ago]
У тебя в листе данные дублируются или что?


Alexander Pilipenko [2 days ago]
Вопрос зачем при необязательном поле делать left join


Alexander Pilipenko [2 days ago]
Если поле заполнено - данные уже есть и лезть никуда не нужно. Если поле не заполнено, мы все равно получим кривые данные (edited)


shtramak [2 days ago]
не могу сказать, не видел этого обсуждения про optional  ¯\_(ツ)_/¯

Alexander Pilipenko [2 days ago]
Там ни к чему не пришли :disappointed:


Alexander Pilipenko [2 days ago]
Нашел ссылку https://stackoverflow.com/questions/43949099/spring-data-jpa-unnecessary-left-join
Stack Overflow
spring data jpa unnecessary left join
I have the following model: I want to get all Institutions (Intituciones) with specified sectorId. In the tbInstitucion model I have a relationship with tbSector: @ManyToOne(fetch=FetchType....
 
 


Alexander Pilipenko [2 days ago]
Там сказано, что нужно сделать чтобы не было left join, но почему он появился не понятно


Alexander Pilipenko [2 days ago]
@Grigory Kislin @Tanya @Katherine Уважаемые менторы, пожалуйста, выскажите свое мнение по данному вопросу


Grigory Kislin [1 day ago]
я за то, чтобы делать все явно
если хочется достать через join - делай fetch либо энтити граф. Либо- как роли- EAGER. 
Кроме того я стараюсь делать все через NamedQuery. 
как хибернайте ведет себя c optional при data-jpa маджик запросах- только в документации и stackowerflow знает


Alexander Pilipenko [1 day ago]
Спасибо


Join_Selectovich [Jul 30th at 11:10 AM]
В crud interface для выборки еды можно создать методы:
1) getAllByUserId
2) getAllByUser_Id
причем они работают одинаково, но наверное в первом случае обращение к таблице идет через поле класса, а во втором случае наверное напрямую к полю таблицы. Так или нет? как думаете ? (edited)


21 replies
Join_Selectovich [2 days ago]
если так, то лучше обращаться за едой через поле класса т.е. получается первый вариант лучше..  как вы считаете?


Victor [2 days ago]
в обоих случаях через поле класса. ПОтому что по названию метода формируется HQL, а в нем только поля и классы.


Join_Selectovich [2 days ago]
Но у еды нет же поля User_Id


Victor [2 days ago]
это магия :slightly_smiling_face:


Victor [2 days ago]
он когда парсит убирает _ (edited)


Join_Selectovich [2 days ago]
сейчас проверю - добавляю два подчеркивания (edited)


Join_Selectovich [2 days ago]
с двумя не работает, наверное убирает ровно одно подчеркиваение  :slightly_smiling_face: (edited)

Victor [2 days ago]
все равно будет HQL и не будет обращения к полям таблицы

Maksim K [2 days ago]
https://topjava14.slack.com/archives/CBX6WTJQ2/p1532939282000289?thread_ts=1532938247.000229&cid=CBX6WTJQ2
у еды и поля UserId вроде как нет)
Rey
Но у еды нет же поля User_Id
From a thread in #hw5Jul 30th at 11:28 AM
 


Join_Selectovich [2 days ago]
Получается при написании(именовании) этих чудо :male_mage:  методов нужно опираться на названия столбцов таблицы .. (edited)


Maksim K [2 days ago]
Я наверно совсем не в теме, но какая разница как назвать метод? Если даже назвать его известным словом из трех букв, то он все равно будет работать. И я не очень понял что написал @Victor по поводу того, что по названию метода формируется HQL. Это как? Жду его объяснений))


Join_Selectovich [2 days ago]
Нет, при именовании нужно придерживаться определенных правил,  я пробовал подмешивать левак - все сразу ломается. (edited)


vch [2 days ago]
левак тоже по-разному можно подмешивать. Например, `findПожалуйстаByIdAndUserId` должно сработать



Victor [2 days ago]
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation


Maksim K [2 days ago]
@Victor я еще не читал твою ссылку, но уже кое-что понял. вернее не понял)) я просто методы реализовывал через запрос к базе данных. поэтому у меня и можно было называть их как угодно. а ща попробовал через этот getAllByUser_Id и без всяких запросов и работает. внатуре магия. надо почитать по этому поводу, как оно так работает


Join_Selectovich [2 days ago]
да, через findПожалуйстаByIdAndUserId работает, и через getПожалуйстаByIdAndUserId работает тоже, но если в другие места мусор подмешивать то нет как-то (edited)



Victor [2 days ago]
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.details



dimlo [1 day ago]
У еды поле UserId наследуется от Abstract BaseEntity

Grigory Kislin [1 day ago]
я когдато подебажил как это работает (кстати рекомендую этот метод - пользы будет больше чем от угадываний): https://habr.com/post/232381/
Spring Data JPA (edited)


Grigory Kislin [1 day ago]
@Maksim K это вопрос про magic методы, HQL которых генерится по их названию

Maksim K [1 day ago]
https://topjava14.slack.com/archives/CBX6WTJQ2/p1532970677000092?thread_ts=1532938247.000229&cid=CBX6WTJQ2
да там вроде как еда наследует свой айдишник, а не юзера...
Dmitry Loshchenkov
У еды поле UserId наследуется от Abstract BaseEntity
From a thread in #hw5Jul 30th at 8:11 PM
(edited)


alexey [Jul 30th at 3:32 PM]
Народ а кто нибудь понял как проверить, что в DataJpaMealRepositoryImpl все обращения к DB выполняются в одной транзакции?? Что то не пойму нужно какой то доп код писать или что?


5 replies
Alexander Pilipenko [2 days ago]
Имхо - дополнительного кода не нужно
Нужно проверить, что если в методе выполняется 2 и более операции с БД, то такой метод и все дочерние методы начинают/продолжают транзакцию.


alexey [1 day ago]
)Спасибо, а то сижу голову ломаю


Victor [1 day ago]
то есть нужно правильно аннотации расставить, как я понял.


Alexander Pilipenko [1 day ago]
И 2 раза проверить, что они там где надо


Alexander Pilipenko [1 day ago]
Ну и в дополнение:
Можно добавить в настройки логгирования
<logger name="org.springframework.transaction" level="trace"/>

После этого в лог будет выведена информация о транзакциях.


Maksim K [Jul 30th at 5:12 PM]
Вопрос по 
`2.2: Для интеграции с IDEA не забудте выставить в spring-db.xml справа вверху в Change Profiles... профили, например datajpa, postgres`
Я вот чего не пойму: какую бы я БД в Change Profiles не выставил все равно будет использоваться та, что в профиле Мавен стоит.  Как сделать чтобы выбиралась та база, что в Change Profiles выставлена?


12 replies
Yevhen Maksymovych [1 day ago]
эта опция не изменяет выбранную реализацию БД, а только заставляет корректно работать интеграцию спринга и идеи. т.е. будет во всяких dependency injection тебя перебрасывать на верную реализацию по клику, и подсказки генерить согласно выбранному профилю (edited)



sky [1 day ago]
в мавене выбирай реализацию базы


Maksim K [1 day ago]
то есть весь этот сыр бор только для интеграции???


Yevhen Maksymovych [1 day ago]
что значит только для интеграции? ты недооцениваешь этот функционал ))


Yevhen Maksymovych [1 day ago]
когда у тебя штук пять профилей, сотня переменных инжектится, и тебе надо это отлаживать, вот эта интеграция делает погоду



Yevhen Maksymovych [1 day ago]
понятно, что когда у тебя в контексте четыре бина сидит, и ты их все по именам знаешь, можно и без этого обойтись


Maksim K [1 day ago]
эмм.. ну может и так) я пока не силен во всем этом. буду иметь ввиду. спасибо)


Maksim K [1 day ago]
@Yevhen Maksymovych еще вопрос. а можно хоть один пример, где мне может пригодиться такая интеграция в нашем коде. Ну то есть где у нас в коде можно посмотреть какую бд я выбрал в Change Profiles?


Yevhen Maksymovych [1 day ago]
@Maksim K если ты про коммит после накатки патчей (до выполнения ДЗ), то у нас там по разным профилям разнесён разный dataSource только, там как таковой интеграции ты красивой не увидишь (мы напрямую в коде датасорс не используем, толкьо для создания других бинов), единственное, тебе идея будет выдавать предупреждение, что у тебя в одном контексте лежит два бина с одинаковым ид. Если выберёшь один из профилей, соответственно, это предупреждение пропадёт. А так-то тебе надо будет разнести по разным профилям реализации репозиториев - тут уже интеграция налицо, ты в сервисе сможешь прыгнуть по щелчку на репозитории в нужную реализацию (ту, которая выбрана в текущем профиле)


Victor [1 day ago]
тут наоборот получилось. В зависимости от того, какой профиль выбран в Maven, собирается правильная конфигурация Spring через ActiveDbProfileResolver.

Grigory Kislin [1 day ago]
@Maksim K в занятии вся эта информация есть (про только для интергации). просто надо внимательней смотреть видео и читать текст

Maksim K [1 day ago]
@Grigory Kislin да вроде все смотрю и читаю. и стараюсь внимательно. ну правда по ссылкам не все читаю. их очень много и прочитать все не успеваю.


Alexander Pilipenko [Jul 30th at 6:09 PM]
Раз уж зашел разговор про смену профилей, то натолкните, пожалуйста, на мысль как починить ActiveProfile(resolver). Он должен возвращать необходимые профили. Профиль БД мы выбираем по наличию класса драйвера.
Но как выбрать нужную реализацию репозитория? (edited)


9 replies
e.pekhterev [1 day ago]
репо автоматом и не должен выставляться, только БД.
тесты сами решают, что им юзАть.


alexey [1 day ago]
жестко прописывай в тестах реализацию

Alexander Pilipenko [1 day ago]
Спасибо.

Victor [1 day ago]
найти dependency, которые соответствуют только одному из профилей у меня не получилось. Поэтому сделал так:
```return new String[]{Profiles.getActiveDbProfile(), "jdbc"};```
(edited)


e.pekhterev [1 day ago]
@Victor прекращай уже решения публиковать) (edited)



e.pekhterev [1 day ago]
тем более, если ещё и неправильное решение, если речь о резолвере


Victor [1 day ago]
не знаю на сколько правильное, но у меня работает. Можно сюда еще вместо string константу для удобства вставить из Profiles.


e.pekhterev [1 day ago]
дай возможность людям  хоть чутка самим подумать)))


Victor [1 day ago]
ок, уговорил, молчу :grin:


svis [7:43 PM]
Странное дело, после накатки второго патча из 5-го урока почему-то в spring-db.xml  idea ругается на jdbc.initLocation в строке -   <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
при этом все нормально компилируется и тесты проходят


svis [Jul 30th at 7:44 PM]
ни у кого такого не было?


4 replies
Victor [1 day ago]
у меня всегда ругалась... Может не замечал?


Maksim K [1 day ago]
и у меня ругается. забей)


Grigory Kislin [1 day ago]
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md
после Apply 4_8_add_hsqldb.patch
> IDEA может ${jdbc.initLocation} подчеркивать красным - тупит...
когда затупить- получается сама решает... (edited)


svis [1 day ago]
Коллеги, спасибо за комментарии! Теперь понятно.


shtramak [7:44 PM]
красным подчеркивает? это чаще всего норм
Apply 4_8_add_hsqldb.patch
ВНИМАНИЕ: патч меняет postgres.properties
IDEA может ${jdbc.initLocation} подчеркивать красным - тупит...

Victor [8:17 PM]
Коллеги, пишете в треды! Зачем flood разводить? (edited)


Ma3stro [Jul 30th at 8:36 PM]
Куда смотреть для реализации следующего?
```7.1: достать по id пользователя вместе с его едой
7.2: достать по id еду вместе с пользователем```
(edited)


7 replies
Alexander Pilipenko [1 day ago]
В задании ссылка


Ma3stro [1 day ago]
@Alexander Pilipenko, Не вижу. Мог бы ты скинуть ссыль?:)

Alexander Pilipenko [1 day ago]
Сделать и протестировать в сервисах методы (тесты и реализация только для DataJpa)
7.1: достать по id пользователя вместе с его едой
7.2: достать по id еду вместе с пользователем
7.3: обращения к DB сделать в одной транзакции (можно сделать разные варианты). Java Persistence/OneToMany


Alexander Pilipenko [1 day ago]
https://en.wikibooks.org/wiki/Java_Persistence/OneToMany


shtramak [1 day ago]
а что дает эта ссылка?)  Почитай про spring data, что это https://spring.io/blog/2011/02/10/getting-started-with-spring-data-jpa



shtramak [1 day ago]
И реализуй по подобию userrepo


Alexander Pilipenko [1 day ago]
Спасибо за ссылку


Maxim Gusev [Yesterday at 1:58 AM]
А как у нас вообще резолвится имплементация репозитория? 

В отличие от БД (@ActiveProfiles(resolver = ActiveDbProfileResolver.class)) для репозиториев такого нет


3 replies
Victor [1 day ago]
пробую через @Profile, но что-то никак SpringMain не запущу


Victor [1 day ago]
с @Profile сделать не вышло, видно не правильный это подход. Запустил другим способом, но не знаю на сколько он хороший.


e.pekhterev [1 day ago]
дана хорошая ссылка в с самое уроке, так что не вижу смысла что то придумывать:
https://dzone.com/articles/using-spring-profiles-xml
dzone.com
Using Spring Profiles in XML Config - DZone Java
Learn how to use spring profiles in an XML config with this great tutorial. (22 kB)


Merkulov [Yesterday at 11:40 AM]
Интересный момент в имплементации метода save вроде как есть уже работа в транзакции :
```@Transactional
    public <S extends T> S save(S entity) {

        if (entityInformation.isNew(entity)) {
            em.persist(entity);
            return entity;
        } else {
            return em.merge(entity);
        }
    }```
но без явного объявления транзакции над методом в интерфейсе не работает метод


15 replies
Yevhen Maksymovych [1 day ago]
должно работать. ну, разве что мы его оверрайднули просто так, и над оверрайднутым методом не указали транзакцию



Merkulov [1 day ago]
не работает, пробовал тесты валятся


Alexander Pilipenko [1 day ago]
Интересно. Покажи код из интерфейса и реализации.

Merkulov [1 day ago]
```@Override
    User save(User user);```
а реализация в классе SimpleJpaRepository выше


Yevhen Maksymovych [1 day ago]
ну так я об этом и говорил, оверрайд есть, а транзакции нет


Yevhen Maksymovych [1 day ago]
зачем зря оверрайдить, если не предполагается изменения реализации :slightly_smiling_face:


Merkulov [1 day ago]
ну попробуй без оверайд

Merkulov [1 day ago]
это первое что я проверил

Merkulov [1 day ago]
не работает и без оверайда

Yevhen Maksymovych [1 day ago]
Pasted image at 2018-07-31, 12:00 PM



Yevhen Maksymovych [1 day ago]
нет, ты не понял, без овеерайда, я имею в виду вообще убрать этот метод из CRUSUserRepository, если не предполагается его реализация. в данном случае, если мы указали, что он оверрайдится, но не сделали реализацию, умный спринг дата сам сделает реализацию. но при этом он сам не откроет транзакцию, потому что от дефолтной реализации мы отказались



Merkulov [1 day ago]
ааа ты про это)


Merkulov [1 day ago]
ок, спс, попробовал работает

Yevhen Maksymovych [1 day ago]
:+1:


Victor [1 day ago]
я на save поставил @Transactional, а чем плохо? Зато в интерфейсе видны методы, которые используешь. Легче для восприятия.


dimlo [Yesterday at 1:06 PM]
Господа, а кто-нибудь использовал T getOne(ID id), чтобы получить ссылку на Юзера и вставить ее в еду?


13 replies
e.pekhterev [1 day ago]
всё должны использовать в этом задании



Victor [1 day ago]
да, я использовал:slightly_smiling_face:


e.pekhterev [1 day ago]
там можно конечно по другому - на скорее всего заругают


dimlo [1 day ago]
Вот я по-другому как раз и сделал:
в CrudMealRepository создал getUser с @Query наверху)
T getOne(Integer id) возвращает Meal, класс Юзера в него не передать... Намекните, что я упустил)

e.pekhterev [1 day ago]
ну так ты же сам себе и отвечаешь сейчас, что вот этот наш репозиторий не работает с Юзерами
public interface CrudMealRepository extends JpaRepository<Meal, Integer> (edited)



e.pekhterev [1 day ago]
т.е. надо что тогда?


Victor [1 day ago]
как понимаю нужно использовать Crud*User*Repository, чтобы достать reference.



dimlo [1 day ago]
Спасибо) Не хотел в CrudUserRepository лезть, подумал, что это увеличит зацепление

e.pekhterev [1 day ago]
@Victor, ну когда ж ты перестанешь подсказывать (edited)

dimlo [1 day ago]
@e.pekhterev да я уже накодил к этому времени)


e.pekhterev [1 day ago]
всё равно, другие могут прочитать


realcorwin [1 day ago]
на ГитХабе в минуту находятся все решения по всем заданиям. Спасать на пепелище уже нечего :slightly_smiling_face:.


svis [20 hours ago]
да это все равно в подсказке есть 6: В Data-Jpa метод для ссылки на entity (аналог em.getReference) : T getOne(ID id)


Joanna [Yesterday at 3:10 PM]
здравствуйте, подскажите пожалуйста, в классе MealServiceImpl repository подчеркивается красным, так как оно не может сделать autowired, поскольку есть несколько бинов. В Maven -> Profiles стоит hsqldb, в файле spring-db.xml - Change Profiles ->hsqldb. Тесты и сервлет вылетают с ошибкой: Caused by: org.springframework.beans.factory.NoUniqueBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected single matching bean but found 4: inMemoryMealRepositoryImpl,dataJpaMealRepositoryImpl,jdbcMealRepositoryImpl,jpaMealRepositoryImpl. C переключанием профилей вроде норм, единственное что знаю это @Qualifier, но есть ли другой способ и в чем подвох? Как сделать так чтобы эти бины не стикались?


20 replies
Yevhen Maksymovych [1 day ago]
разделить по профилям в конфигурации спринга


Yevhen Maksymovych [1 day ago]
ну и, соответственно, при запуске тестов указывать, какой профиль использовать


Joanna [1 day ago]
https://github.com/JolaPsh/topjava/blob/HW05/src/main/resources/spring/spring-db.xml
src/main/resources/spring/spring-db.xml
```<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:context="http://www.springframework.org/schema/context"```
Show more…
JolaPsh/topjavaAdded by GitHub


Joanna [1 day ago]
а если  уже разделила?

Yevhen Maksymovych [1 day ago]
```<context:component-scan base-package="ru.javawebinar.**.repository"/>```


Yevhen Maksymovych [1 day ago]
вот эта штука у тебя сидит вне профилей, она просканирует все репозитории, и все загрузит в контекст


Yevhen Maksymovych [1 day ago]
независимо от того, какой профиль ты выберешь


Yevhen Maksymovych [1 day ago]
потому все четыре туда и падают



Joanna [1 day ago]
спасибо большое, а то я бы долго думала, че с этим делать) буду исправлять, но уже другие ошибки:relaxed:

Yevhen Maksymovych [1 day ago]
:+1:

e.pekhterev [1 day ago]
@Joanna *_HW05_Not_finished_yet_* - шикарнейшее имя для коммитов))



Joanna [24 hours ago]
ну блин.........а у тя как?


e.pekhterev [24 hours ago]
я обычно коммичу каждый выполненный пункт дз

e.pekhterev [24 hours ago]
1.png


e.pekhterev [24 hours ago]
оно хотя бы понятно потом, что в каждом коммите есть


Joanna [23 hours ago]
по-рабочему

e.pekhterev [23 hours ago]
лучше сейчас уже привыкать делать правильно, чем получать по рукам на работе

Joanna [23 hours ago]
ок, буду исправляться:jack_o_lantern:


Joanna [23 hours ago]
:skull:


e.pekhterev [23 hours ago]
)))


Merkulov [Yesterday at 4:34 PM]
При получении пользователя с едой не проходит тест, пишет что данные еды не совпадают с ожидаемым результатом, хотя полностью уже все перепроверил данные идентичны , в чем может еще быть проблема ?
Сравниваю вот так :
```assertThat(actual).isEqualToIgnoringGivenFields(expected, "registered", "roles");```


9 replies
vch [23 hours ago]
а если в 2 этапа проверку сделать - проверять поля юзера без еды? И отдельно - лист с едой сравнить с эталонным?


Merkulov [23 hours ago]
без еды проходит, а с едой нет

vch [23 hours ago]
зачем тебе сразу с едой проверять? Ты ведь уже игнорируешь часть полей при сравнении. Добавь в игнорирование поле `meals`


Merkulov [23 hours ago]
ну это ведь по заданию нужно сравнить еду пользователя

Merkulov [23 hours ago]
кстати когда проверяешь по отдельности все работает


vch [23 hours ago]
Но не написано, что это должен быть 1 вызов `assertThat`. Можно 2 раза вызвать - отдельно юзера с игнором еды и отдельно еду


Merkulov [23 hours ago]
нужно разобраться почему не работает за один вызов

Merkulov [23 hours ago]
интересно, может как-то кеш влияет, хотя вроде как перед каждым тестом идет его очищение, непонятно


Merkulov [23 hours ago]
проверяю по отдельности вот так :
```// FIXME
    @Test
    public void getByIdWithMeals() throws Exception {
        User actual = service.getByIdWithMeals(ADMIN_ID);
        UserTestData.assertMatch(actual, UserTestData.ADMIN);
        MealTestData.assertMatch(actual.getMeals(), MealTestData.ADMIN_MEAL2, MealTestData.ADMIN_MEAL1);
    }```


Prodigy [Yesterday at 5:14 PM]
Народ, кто-то как-то изгалялся с названиями методов в CrudMealRepository или писали запросы вручную?


28 replies
Join_Selectovich [23 hours ago]
конечно эксеперементировали :microscope:


Prodigy [23 hours ago]
получилось что-то?


Join_Selectovich [22 hours ago]
ну да


e.pekhterev [22 hours ago]
только с методом getWithUser не вышло магию применитьь


e.pekhterev [22 hours ago]
остальные методы отлично на черненькой работают без доп. квери

Johann [22 hours ago]
вся реализация получается без запросов, кроме getWithUser, как уже подметили

Join_Selectovich [22 hours ago]
поля user в таблице нет - поэтому и не работает (edited)

Prodigy [22 hours ago]
getWithUser это вы имеете ввиду получить всю еду пользователя?


e.pekhterev [22 hours ago]
вот тут почитай - буквально только что обсуждали всё это - https://topjava14.slack.com/archives/CBX6WTJQ2/p1532938247000229
Rey
В crud interface для выборки еды можно создать методы:
1) getAllByUserId
2) getAllByUser_Id
причем они работают одинаково, но наверное в первом случае обращение к таблице идет через поле класса, а во втором случае наверное напрямую к полю таблицы. Так или нет? как думаете ?
Thread in #hw5Jul 30th at 11:10 AM


e.pekhterev [22 hours ago]
и ещё выше было тоже обсуждение


e.pekhterev [22 hours ago]
@Prodigy нет, getWithUser - получить один meal по его id и при этом чтоб юзер у него в поле был не лейзи


Prodigy [21 hours ago]
и с between получилось?

Prodigy [21 hours ago]
чет не найду ничего внятного

dimlo [21 hours ago]
получилось


dimlo [21 hours ago]
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/
find between по документу)


Prodigy [21 hours ago]
эээ.... я тут смотрел уже, но у нас же специфичный метод с тремя аргументами..... но я выкрутился, длинный метод получился)


e.pekhterev [21 hours ago]
только на магии или с доп. квери?

dimlo [21 hours ago]
ну да, у меня тоже

dimlo [21 hours ago]
@e.pekhterev только

e.pekhterev [21 hours ago]
ну оно и правильно - что квери был бы длинный, что название метода, которое будет разобрано для получения этого же квери


Prodigy [21 hours ago]
ага, без доп квери

tim [20 hours ago]
А с сортировкой пробовали по типу:    List<Meal> findAllByUserIdSort(int userId, Sort sort);


tim [20 hours ago]
у меня не заработало...


Prodigy [20 hours ago]
а так `OrderByDateTimeDesc` не работало?

tim [20 hours ago]
Так не пробовал а где все эти ключевые  слова можно увидеть в одной табличке?

Prodigy [20 hours ago]
чуть выше ссылку давали

tim [20 hours ago]
Спасибо! Так работает:slightly_smiling_face:


Kirilo [5 hours ago]
идея сама подсказывает что писать, главное подбирать :slightly_smiling_face: Все довольно логично и интуитивно понятно сделано (edited)


Join_Selectovich [Yesterday at 8:50 PM]
Товарищи подскажите пожалуйста, может кто на такую ошибку натыкался после переключения БД на HSQLDB получаю для JDBC реализации
_org.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar [SELECT * FROM meals WHERE user_id=?  AND date_time BETWEEN  ? AND ? ORDER BY date_time DESC]; nested exception is java.sql.SQLSyntaxErrorException: incompatible data type in conversion_ (edited)


3 replies
Yevhen Maksymovych [19 hours ago]
hsqldb нашей версии не умеет в LocalDateTime



Join_Selectovich [19 hours ago]
аааа..... точно (edited)


Kirilo [4 hours ago]
Кстати, H2 поддерживает: https://marschall.github.io/2017/01/11/h2-310.html (edited)


stea1th [Yesterday at 11:46 PM]
товарищи, так сколько должно быть классов в 3 задании?


9 replies
Join_Selectovich [16 hours ago]
у меня было 2 а стало 9



e.pekhterev [16 hours ago]
у меня было 2, а стало 11)))


stea1th [16 hours ago]
ого


stea1th [16 hours ago]
а зачем столько?


stea1th [16 hours ago]
мне только для 3 задания.. без опционала


Join_Selectovich [16 hours ago]
почитай 5ый пункт и по подсказкам пройдись


stea1th [16 hours ago]
я пока до пятого пункта не дошел... меня интересуе количество классов для 3 пункта

stea1th [16 hours ago]
как я понял для 3-его пункта достаточно 3 классов... 1 общий абстрактный и два наших старых класса, унаследованные от него?


Join_Selectovich [16 hours ago]
да, и для каждой реализации репозитария еще т.е. умножай на 3


Join_Selectovich [Today at 12:01 AM]
Не пойму как подступиться к пункту 
*5: Разделить JdbcMealRepositoryImpl для HSQLDB (она не умеет работать с Java8 Time API) и Postgres через @Profile (для Postgres оставить LocalDateTime).*  дайте пожалуйста наводку :slightly_smiling_face:


55 replies
Victor_D [16 hours ago]
2: В реализациях JdbcMealRepository код не должен дублироваться (edited)



zippospb [16 hours ago]
Hsqldb не понимает localDateTime. Ему подавай вариант из java.util.date. Разделение реализаций надо будет с помощью паттерна шаблонный метод


Victor_D [16 hours ago]
там скорее java.sql.Timestamp

zippospb [16 hours ago]
Так он из этого пакета и есть (edited)

zippospb [16 hours ago]
Аа не

zippospb [16 hours ago]
Он экстендит java.util.date наврал

Join_Selectovich [16 hours ago]
А, так получается 2 реализации ЖиДиБиСи реопзитория нужно запилить...

zippospb [16 hours ago]
Ага


Victor_D [16 hours ago]
можно и окольными путями пойти...


zippospb [16 hours ago]
Окольными? Там же сказано, каким именно путем пойти

Victor_D [16 hours ago]
После выполнения разделения можно предложить решение проще.

zippospb [16 hours ago]
Блин. Согласен



Stanislav [16 hours ago]
Наводка: паттерн шаблонный метод можно инкапсулировать. (edited)


Stanislav [15 hours ago]
По поводу
```решение проще```
выше уже обсуждали, делается 1 строчкой.


Join_Selectovich [15 hours ago]
я так понял в 5ом пункте @Profile = @ActiveProfile имелся в виду? (edited)


Join_Selectovich [15 hours ago]
Пытаюсь понять:
_Например при сконфигуренном @Profile({"postgres","jdbc"}) бин попадет в контекст, если в профилях запущенного приложения есть хотя бы один из них (например "jdbc")._
т.е. если включена БД постгрес - то в контейнер бинов подгрузятся экземпляры спрофилированные в jdbc разделе, так что-ли? (edited)


Alexander Pilipenko [15 hours ago]
Одной строчкой сразу в 2 методах ?

Victor_D [15 hours ago]
@Join_Selectovich `@Profile({"postgres", "jdbc"}) - бин под этой аннотацией будет работать, если будут выбраны профайлы  postgres и jdbc
https://dzone.com/articles/using-spring-profiles-xml (edited)


Join_Selectovich [7 hours ago]
Блин, так тут речь шла о профилях Maven.... теперь все понятно стало

Kirilo [6 hours ago]
а ты запусти тесты с включенным только профилем hsqldb в maven

Join_Selectovich [6 hours ago]
я запускал


Kirilo [6 hours ago]
Сразу видно какие методы отвалились

Join_Selectovich [6 hours ago]
create , update , between - все кто с датой работают (edited)


Kirilo [6 hours ago]
не. Открой jdbc и увидешь (edited)


Kirilo [6 hours ago]
у нас же save - это и create и update


Kirilo [6 hours ago]
https://stackoverflow.com/questions/8992282/convert-localdate-to-localdatetime-or-java-sql-timestamp
Stack Overflow
Convert LocalDate to LocalDateTime or java.sql.Timestamp
I am using JodaTime 1.6.2. I have a LocalDate that I need to convert to either a (Joda) LocalDateTime, or a java.sqlTimestamp for ormapping. The reason for this is I have figured out how to convert
 


Kirilo [6 hours ago]
Я вот так сделал: @Profile(Profiles.HSQL_DB)
public class HsqlJdbcMealRepositoryImp extends AbstractJdbcMealRepositoryImpl {....
}



Kirilo [6 hours ago]
В тестах тоже можно дебажить, тогда видно в каком ты профиле находишься, когда проганяется каждый метод теста (edited)

Alexander Pilipenko [5 hours ago]
@Kirilo А можно скриншот, где это указано? (edited)


Kirilo [5 hours ago]
меняешь профиль и проганяешь тесты. Сразу видишь где остановится, с каким профилем (edited)

Alexander Pilipenko [5 hours ago]
Так поэтому и спросил, что не вижу

Alexander Pilipenko [5 hours ago]
Pasted image at 2018-08-01, 10:54 AM



Kirilo [5 hours ago]
В даном случае профиль базы в maven галочки ставим/убираем, а профиль реализации репозитория в файле Profiles

Alexander Pilipenko [5 hours ago]
:disappointed:


Alexander Pilipenko [5 hours ago]
А так хотелось зайти в отладку и увидеть какой точно профиль выбран


Alexander Pilipenko [5 hours ago]
А не смотреть в maven

Kirilo [5 hours ago]
Я ставил брекпойнты в методах тестов, менял значения константы REPOSITORY_IMPLEMENTATION = ... И запускал тесты, а базы в maven галочки переставлял (edited)

Alexander Pilipenko [5 hours ago]
Пока нашел только такой вариант, который действительно показывает  задействованные профили:

Добавляем туда, где нужно отлаживаться (например в тест)
@Autowired
   public org.springframework.core.env.Environment env;

После этого в этой переменной можно увидеть activeProfiles


Alexander Pilipenko [5 hours ago]
Pasted image at 2018-08-01, 11:04 AM



Kirilo [5 hours ago]
ну, да. В отладке есть. Но мне так дольше было искать, чем просто править, запускать дебаг и смотреть в каком файле остановка. Я выбирал всю папку service. А Идея, заметил, подглючивает даже с раскраской профилей. (edited)

Alexander Pilipenko [5 hours ago]
В файл мы можем попасть по разным профилям да еще и по ошибке.


Kirilo [5 hours ago]
мы видим какой профиль задействован

Kirilo [5 hours ago]
из-за того, что у нас в рантайме подмена реализации


Alexander Pilipenko [5 hours ago]
Ок. У нас 2 БД postgres. DEV и TEST. Соответствующие профили.
Мы попадаем в 1 и тот же метод
Если не прописывать org.springframework.core.env.Environment env
Где посмотреть по какому профилю я пошел? (edited)


Kirilo [5 hours ago]
одну только выбирать (edited)

Kirilo [5 hours ago]
Я не заморачивался так. Просто галочку в maven снимал и оставлял только одну из двух


Alexander Pilipenko [5 hours ago]
Так база одна и таже :slightly_smiling_face: В мавен тот же профиль


Kirilo [5 hours ago]
так у нас два профиля

Kirilo [5 hours ago]
для базы и для репозиториев (edited)

Alexander Pilipenko [5 hours ago]
А еще наше приложение работает с 2 установленными галочками в maven


Kirilo [5 hours ago]
одну оставлять нужно Иначе не поймешь (edited)

Kirilo [5 hours ago]
Потому, как по умолчанию постгрес выбирается (edited)


Kirilo [5 hours ago]
вторая только по экзепшину выберется в таком случае (edited)

Alexander Pilipenko [5 hours ago]
:slightly_smiling_face:

Kirilo [5 hours ago]
public class Profiles {
   public static final String
           JDBC = "jdbc",
           JPA = "jpa",
           DATAJPA = "datajpa";

   public static final String REPOSITORY_IMPLEMENTATION = JPA;

   public static final String
           POSTGRES_DB = "postgres",
           HSQL_DB = "hsqldb";

   //  Get DB profile depending of DB driver in classpath
   public static String getActiveDbProfile() {
       try {
           Class.forName("org.postgresql.Driver");
           return POSTGRES_DB;
       } catch (ClassNotFoundException ex) {
           try {
               Class.forName("org.hsqldb.jdbcDriver");
               return Profiles.HSQL_DB;
           } catch (ClassNotFoundException e) {
               throw new IllegalStateException("Could not find DB driver");
           }
       }
   }
}


Andrew [Today at 12:32 AM]
Народ, а есть какие сылочки по профилированию? Проблема возникает при работе с профилем (beans profile не видит datasource) в то же время если прописываю datasource, как простой бин приложение работает, знать бы хоть в каком направлении смотреть...


10 replies
Join_Selectovich [15 hours ago]
что значит _beans profile не видит datasource_ ?


Victor_D [15 hours ago]
ссылки из дз https://dzone.com/articles/using-spring-profiles-xml
https://www.mkyong.com/spring/spring-profiles-example/
dzone.com
Using Spring Profiles in XML Config - DZone Java
Learn how to use spring profiles in an XML config with this great tutorial. (22 kB)


Prodigy [14 hours ago]
статья, увы, не раскрывает тему вложенных бинов, а только краем ее касается. Тоже какая-то лабуда с профайлами


Kirilo [5 hours ago]
Мне очень здорово помог дебаг. Ставишь брекпойнты на все свои методы и запускаешь тесты. А дальше крутишь свои профили как хочешь и снова запускаешь тесты (edited)


Prodigy [5 hours ago]
у него проблема в том что он сделал вложенные бины а активные профиля в тестах не указал, поэтому ничего не видит

Kirilo [5 hours ago]
Я заметил, что с каждым уроком все тяжелее делать задания. Столько подводных камней всплывает.


Andrew [5 hours ago]
и где мне ставить брекпойнты в XML ? У меня при запуске простого списка еды вылетает: NoSuchBeanDefinitionException: No bean named 'dataSource' available


Kirilo [5 hours ago]
Помоему, как с профилями работать становится понятно, после второго задания с перетягиванием бинов по профилям в spring-db. Если делать по одному профилю и дебажишь каждый файл репозитория, то все становится ясно (edited)

Kirilo [5 hours ago]
Сейчас будут работать только тесты


Kirilo [5 hours ago]
А чинится все в optional, когда контекст спринга настраиваешь, добавляя профили (edited)


turhanow [Today at 1:57 AM]
привет всем. у кого то такое было?
`Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}`

не могу вылечить...


41 replies
Prodigy [14 hours ago]
с профайлами небось воюешь?... как я тебя понимаю


turhanow [14 hours ago]
иногда у меня складывается впечатление, что я тупее других в группе...:white_frowning_face:


Prodigy [14 hours ago]
у меня та же проблема, пока не понимаю где я че упустил и как оно структурно должно быть

Prodigy [14 hours ago]
я по поводу профайлов

turhanow [14 hours ago]
соответсвенно я даже не знаю проходят тесты или нет, потому базовую часть не получается выполнить..


Prodigy [14 hours ago]
ты сначала по профайлам разнес всё ?

Prodigy [14 hours ago]
у меня такая фигня после разнесения по профайлам конфигурации


turhanow [14 hours ago]
то есть тесты до разнесения у тебя ок? (edited)


Prodigy [14 hours ago]
ага

Victor [13 hours ago]
чтобы тесты сделать, копируйте нужные бины из профайлов в основную часть (временно)
а победить их тяжело, у меня много времени ушло.


Victor [13 hours ago]
Что интересно, у меня уже 3мя способами получилось сделать, может еще и четвертый получиться осилить.:face_with_head_bandage: (edited)


Prodigy [13 hours ago]
судя по ошибке он не видит реализацию MealRepository, т.е. он ВООБЩЕ не видит что у нас во вложеных <beans profile=


Prodigy [13 hours ago]
куда воткнуть аннотацию @Profile

Prodigy [13 hours ago]
а так вообще правильно сделать `@ActiveProfiles(profiles = {"hsqldb","jpa"})` ?.... так все работает (edited)


Kirilo [4 hours ago]
:slightly_smiling_face: У нас же должно выбираться, через галочки. (edited)


Kirilo [4 hours ago]
@Repository
@Profile(Profiles.HSQL_DB)

Prodigy [4 hours ago]
над репозиторием профайл?... это было неожиданно.... а куда тогда воткнуть `Profiles.JPA` ?


Prodigy [4 hours ago]
шото с этими профилями много вопросов и мало ответов

Kirilo [4 hours ago]
а то уже из другой оперы


Kirilo [4 hours ago]
У нас два профиля. Один на базу, другой на репозитории (edited)


Kirilo [4 hours ago]
Мы не должны жестко прикручивать профиль к файлам

Kirilo [4 hours ago]
Это только для конкретного случая с jdbc и hsqldb


Kirilo [4 hours ago]
У нас все конфигурится через спринг контекст и maven, когда мы переставляем галочки перед запуском. (edited)

Kirilo [3 hours ago]
Для начала нужно запустить все тесты, а в задании optional все остальное чинится.


dimlo [3 hours ago]
Я остановился на следующем варианте: после разделения тестов ActiveProfiles(resolver = ...) поставил над AbstractTest (класс, от которого наследую все тесты), а над каждым тестом указал профиль реализации


Kirilo [3 hours ago]
Ну, да. Для тестов так и требовалось, над каждым свой профиль, но я вот, так делал, например, @ActiveProfiles(Profiles.DATAJPA) (edited)

Maksim K [3 hours ago]
@turhanow у тебя эта ошибка скорее всего из-за того, что ты в ...ServiceTest не указываешь какой профиль доступа к БД использовать. то есть для выполнения тестов тебе нужно подконектиться к бд, а тесты не могут найти хоть какую реализацию.


Maksim K [3 hours ago]
или ты указываешь, но неправильно)

Kirilo [3 hours ago]
Чтобы понять, нужно на всех методах в реализациях репозиториев брекпойнты поставить и запустить все тесты. Если нигде не остановится, значит профиль вообще не выбран.

Prodigy [3 hours ago]
@Kirilo а смысл тогда над репозиторием ставить аннотацию `@Profile`? тогда какой толк будет от переключения галочек, если придется ходить в каждый репозиторий и менять вручную профиль


Kirilo [3 hours ago]
А там задание есть, нужно разделить (edited)


Kirilo [3 hours ago]
Optional

   5: Разделить JdbcMealRepositoryImpl для HSQLDB (она не умеет работать с Java8 Time API) и Postgres через @Profile (для Postgres оставить LocalDateTime).


Prodigy [3 hours ago]
ну ладно... я еще до этого не дошел. То есть, мы накидываем на каждый тест активные профиля и это будет правильным решением?


Kirilo [3 hours ago]
@Prodigy Толк будет только в момент конфигурации спринга. Там подмениваем константы, когда выбираем галочки. Это уже в Optional (edited)


Kirilo [3 hours ago]
3: Сделать тесты всех реализаций (jdbc, jpa, datajpa) через наследование (без дублирования)

   3.1 сделать один базовый класс для MealServiceTest и UserServiceTest.

Prodigy [3 hours ago]
хорошо, делаем базовый класс, а потом мы должны от каждого *ServiceTest сделать наследников для каждой реализации?(jdbc,jpa,datajpa) (edited)


Kirilo [3 hours ago]
логично. И как думаешь, что там поменяется у них?

Prodigy [3 hours ago]
ну видимо только @ActiveProfile

Kirilo [3 hours ago]
:slightly_smiling_face:


Kirilo [3 hours ago]
Класно тут Григорий с ООП, тестами и контекстом спринга понакручивал, сразу все проходишь, заодно и дебаг, и идею изучаешь. (edited)


Prodigy [3 hours ago]
ага, без сто грамм не разобраться)


stea1th [Today at 1:04 PM]
ребята, а кто что делал, чтоб тесты не копились?


17 replies
Kirilo [3 hours ago]
Третье задание?


stea1th [3 hours ago]
вот это : 9: Проверьте, что все тесты запускаются из Maven (имена классов тестов удовлетворяют соглашению) и итоги тестов класса выводятся корректно (не копятся)


Kirilo [3 hours ago]
Это знает только Григорий, наверное :slightly_smiling_face:


stea1th [3 hours ago]
это мне Таня на ревью написала


Kirilo [3 hours ago]
Надо уточнить, что такое "копятся" :slightly_smiling_face: (edited)


stea1th [3 hours ago]
ну чтобы не повторялись

Stanislav [3 hours ago]
Если не умеешь читать код, напиши своими словами как формируются итоги в нашем проекте.



stea1th [3 hours ago]
---------------------------------
Test                 Duration, ms
---------------------------------
updateNotFound                114
create                         47
delete                        182
getAll                         30
update                         92
getNotFound                    27
deleteNotFound                 16
get                            19
getBetween                     39
updateNotFound                 31
create                        132
delete                         18
getAll                         17
update                         12
getNotFound                    11
deleteNotFound                 12
get                            23
getBetween                     19
updateNotFound                 25
create                         63
delete                         24
getAll                         17
update                         20
getNotFound                    18
deleteNotFound                 69
get                            25
getBetween                     26
create                        218
delete                         37
getAll                         18
update                         24
getNotFound                    14
get                            14
deletedNotFound                13
getByEmail                     22
duplicateMailCreate            33
create                         45
delete                         21
getAll                         15
update                         21
getNotFound                    12
get                            12
deletedNotFound                14
getByEmail                     20
duplicateMailCreate            99
create                         28
delete                         38
getAll                         23
update                         26
getNotFound                    21
get                            23
deletedNotFound                17
getByEmail                     17
duplicateMailCreate            21
---------------------------------


stea1th [3 hours ago]
чтоб видимо такого не было


Alexander Pilipenko [3 hours ago]
проcтыня :slightly_smiling_face: (edited)


Alexander Pilipenko [3 hours ago]
https://topjava14.slack.com/archives/CBX6WTJQ2/p1533118414000099?thread_ts=1533117845.000051&cid=CBX6WTJQ2
Stanislav Esin
Если не умеешь читать код, напиши своими словами как формируются итоги в нашем проекте.
From a thread in #hw5Today at 1:13 PM


Alexander Pilipenko [3 hours ago]
Ну или посмотри в логе. Сначала итог по первому классу тестов. Потом по второму классу тестов.


Kirilo [3 hours ago]
Это для седьмого задания Optional вопрос

Kirilo [3 hours ago]
Потому как у нас старые тесты не меняются практически

stea1th [3 hours ago]
нет, это для обычного задания

Kirilo [3 hours ago]
А как ты умудрился их поменять?

stea1th [3 hours ago]
короче надо просто каждый раз обнулять стрингбилдер и все


Alexander Pilipenko [1:33 PM]
Начиная со Spring 5.1 можно будет в @Profile использовать операцию AND: https://jira.spring.io/browse/SPR-12458 (edited)


Макс Куркудюк [Today at 3:26 PM]
У мене після останнього патча не робить жоден тест...
java.lang.IllegalStateException: Failed to load ApplicationContext
...
Caused by: java.lang.ClassNotFoundException: com.sun.xml.internal.bind.v2.ContextFactory

Може у когось була така проблема... (edited)


10 replies
Maksim K [24 minutes ago]
скинь всю ошибку


Макс Куркудюк [16 minutes ago]
Новый текстовый документ.txt
java.lang.IllegalStateException: Failed to load ApplicationContext
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)
  at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:108)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.injectDependencies(DependencyInjectionTestExecutionListener.java:117)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.prepareTestInstance(DependencyInjectionTestExecutionListener.java:83)
  at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot create inner bean 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#2a8d39c4' of type [org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter] while setting bean property 'jpaVendorAdapter'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#2a8d39c4' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#38234a38' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#38234a38' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is javax.cache.CacheException: org.ehcache.xml.exceptions.XmlConfigurationException: Error parsing XML configuration at file:/D:/Project/topjava/target/classes/cache/ehcache.xml
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:327)
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:124)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1611)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1363)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:580)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:503)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:317)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:222)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:315)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)
  at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1089)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:859)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:550)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:128)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:60)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.delegateLoading(AbstractDelegatingSmartContextLoader.java:107)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.loadContext(AbstractDelegatingSmartContextLoader.java:243)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:99)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:117)
  ... 24 more
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#2a8d39c4' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#38234a38' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#38234a38' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is javax.cache.CacheException: org.ehcache.xml.exceptions.XmlConfigurationException: Error parsing XML configuration at file:/D:/Project/topjava/target/classes/cache/ehcache.xml
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:589)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:503)
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:312)
  ... 42 more
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#38234a38' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#38234a38' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is javax.cache.CacheException: org.ehcache.xml.exceptions.XmlConfigurationException: Error parsing XML configuration at file:/D:/Project/topjava/target/classes/cache/ehcache.xml
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveReference(BeanDefinitionValueResolver.java:378)
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:110)
  at org.sp...
Collapse This snippet was truncated for display: see it in full.


Alexander Pilipenko [7 minutes ago]
Может я не прав, но в ошибке есть: Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot create inner bean 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#2a8d39c4'


Alexander Pilipenko [6 minutes ago]
У тебя профиль spring в тесте и профиль maven одинаковые?


Alexander Pilipenko [5 minutes ago]
Ну и попробуй maven clean, а затем реимпорт в мавене


Макс Куркудюк [5 minutes ago]
Так, postgres в обох випадках..

Maksim K [5 minutes ago]
а джава какая стоит?


Макс Куркудюк [2 minutes ago]
jdk-9.0.4

Maksim K [1 minute ago]
:grin:


Макс Куркудюк [< 1 minute ago]
maven clean і реимпорт в мавене не допомогли..

Макс Куркудюк [< 1 minute ago]
Просто до останнього патча - всі тести працювали.. Перевіряв.

Maksim K [< 1 minute ago]
`<dependency>
           <groupId>javax.annotation</groupId>
           <artifactId>javax.annotation-api</artifactId>
           <version>1.3.1</version>
       </dependency>
       <dependency>
           <groupId>javax.xml.bind</groupId>
           <artifactId>jaxb-api</artifactId>
           <version>2.3.0</version>
       </dependency>
       <dependency>
           <groupId>com.sun.xml.bind</groupId>
           <artifactId>jaxb-core</artifactId>
           <version>2.3.0</version>
       </dependency>
       <dependency>
           <groupId>com.sun.xml.bind</groupId>
           <artifactId>jaxb-impl</artifactId>
           <version>2.3.0</version>
       </dependency>`
в помнике это попробуй прописать


Alexander Pilipenko [< 1 minute ago]
Это для jdk-9 и выше?
