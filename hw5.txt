Grigory Kislin [6:25 AM]
joined #hw5.

Grigory Kislin [6:25 AM]
Добро пожаловать на урок 5: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md (edited)
Заканчиваем с базой данных (Spring Data JPA), на следующем уроке перейдем к слою web. (edited)

Kirilo [6:28 AM]
joined #hw5 along with 18 others.

Prodigy [12:31 PM]
Есть вопрос: в нашем многопользовательском приложении для каждого пользовательского запроса создается отдельный экземпляр EntityManager с своим контекстом хранения?


Yevhen Maksymovych [Yesterday at 12:47 PM]
Энтити менеджер создаётся на каждый запрос, а общий контекст, я так понимаю, сидит в фабрике


73 replies
e.pekhterev [1 day ago]
точно ли на каждый запрос? 
репозиторий у нас синглТон, у него есть поле *em*, и т.е. ты хочешь сказать на каждом запросе у нас это поле меняется (получает из фабрики новый экземпляр EntityManager)? (edited)


Prodigy [1 day ago]
я так понимаю что в каждой транзакции создается контекст хранения, который по закрытии транзакции закрывается, что с объектом EntityManager происходит, он существует один на всех или же он создается каждый раз?


Yevhen Maksymovych [1 day ago]
гхм, вот щаз задумался. документация говорит, что энтитименеджер легковесный объект, который является аналогом сессии, но здесь мы его действительно автовайрим при создании


Prodigy [1 day ago]
и как вообще тогда шарится объект EntityManager между пользователми


Yevhen Maksymovych [1 day ago]
думаю, проще всего поставить дебаг в какой-нибудь криэйт, вызвать его несколько раз кряду, и посмотреть, что происходит с энтитименеджером


Yevhen Maksymovych [1 day ago]
щаз под рукой нет ноута с проектом

e.pekhterev [1 day ago]
чёт я думал, что один на всех, особенно в том плане, что если мы создадим бин CriteriaBuilder по классике через xml и будем его автовааярить в репозитории, то по идее и он тогда должен переопределяться, короче спортное утверждение.


Yevhen Maksymovych [1 day ago]
дёрнуть его из нескольких сессий, и проверить, один он, или много его, собаки такой )) (edited)



e.pekhterev [1 day ago]
ща проверю

Yevhen Maksymovych [1 day ago]
если кто-то попробует, напишите, самому интересно, а то до ноута раньше вечера не доберусь


e.pekhterev [1 day ago]
дернул из разных браузеров и просто посмотрел что в туСтринге:
------------------!!!!!!!! ENTITY MANAGER !!!!!!!!!!!!!!----------------------
Shared EntityManager proxy for target factory [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@4a62b7dc]


e.pekhterev [1 day ago]
ну как бы один и тот же EM, что и требовалось доказать

Yevhen Maksymovych [1 day ago]
а контекст его вывести на каждом запросе?

e.pekhterev [1 day ago]
как?

e.pekhterev [1 day ago]
ааа, пропертиез


e.pekhterev [1 day ago]
хотя нет

e.pekhterev [1 day ago]
как вывести контекст?

Prodigy [1 day ago]
т.е. когда у нас в один момент куча пользователей пытается дергать данные из базы, один единственный объект EntityManager разрывается между всеми контекстами хранения пользователей? или может он в очередь ставит запросы от пользователей?


e.pekhterev [1 day ago]
черт его знает


e.pekhterev [1 day ago]
я попробовал из разных браузеро - и под юзером, и под админом ссылается на тот же объект EM

e.pekhterev [1 day ago]
ну оно и логично с точки зрения синглтона репозитория

Yevhen Maksymovych [1 day ago]
с точки зрения архитектуры вопросов нет, странно с точки зрения логики


Yevhen Maksymovych [1 day ago]
http://www.spring-source.ru/docs_simple.php?type=manual&theme=docs_simple&docs_simple=chap03_p03
spring-source.ru
Spring framework - Основные интерфейсы
Spring Framework на русском языке. Автор сайта: Бородин Артем. Категория: Программирование, Язык: русский. Тема: Spring framework Основные интерфейсы


Prodigy [1 day ago]
возможно тут можно проверить как, это посмотреть куда ссылается  объект EntityManager в каждом запросе пользователя (edited)

Yevhen Maksymovych [1 day ago]
вот тут в статье каждый рез берётся новый энтитименеджер для каждой новой транзакции


Prodigy [1 day ago]
это фабрика - org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@4a62b7dc

Yevhen Maksymovych [1 day ago]
может мы для простоты савтовайрили его, а на практике так делать не следует, следует вайрить фабрику?

e.pekhterev [1 day ago]
в том то и дело, что в нашем реешнии мы не юзаем явно транзакции, не коммитим их, и не закрываем после EM

Yevhen Maksymovych [1 day ago]
а, так там и есть фабрика


Yevhen Maksymovych [1 day ago]
я не глянул лог

e.pekhterev [1 day ago]
да, фабрика у нас, которая дает нам один EM с помощью аннотации @PersistenceContext

e.pekhterev [1 day ago]
Expresses a dependency on a container-managed EntityManager and its associated persistence context.

e.pekhterev [1 day ago]
т.е. контекст у нас всё же один для одного EM

e.pekhterev [1 day ago]
короче странно, нужно мнение менторов и объясннение, а то так не понятно


e.pekhterev [1 day ago]
а то это как то с требованиям ACID для трансакций не согласуется

Prodigy [1 day ago]
контекст у нас точно разный для каждой транзакции должен быть

e.pekhterev [1 day ago]
раз разный контекст, значит и разные EM должны быть

e.pekhterev [1 day ago]
но у нас один, либо я что то не так делаю

Prodigy [1 day ago]
по идее в каждом потоке должна быть своя копия данных и контекст хранения, который должен видимо создаваться фабрикой, значит и EntityManager должен быть уникальный


e.pekhterev [1 day ago]
в общем не понятно в чём тут суть

Yevhen Maksymovych [1 day ago]
а давайте позовём Дедушку Мороза

Yevhen Maksymovych [1 day ago]
не в том плане, что Григорий морозится, а в том, что дедушка мороз всегда выручит ))

Yevhen Maksymovych [1 day ago]
короче, надо мнение знатока :slightly_smiling_face:

e.pekhterev [1 day ago]
да хотя бы Снегурочка пришла что ли)))) (edited)

e.pekhterev [1 day ago]
@Yevhen Maksymovych добавь вызовы деда мороза и снегурочек в шапку этой ветки с помощью собак, может обратят внимание)) (edited)


Grigory Kislin [1 day ago]
@Prodigy честно- не понимаю...
есть целое первое видео + комментарий к нему снизу про EntityManager ...с прямым ответом на вопрос...



Prodigy [1 day ago]
:slightly_smiling_face::slightly_smiling_face::slightly_smiling_face:

e.pekhterev [1 day ago]
я ещё не смотрел))) сейчас приступлю))

Prodigy [1 day ago]
признаюсь, я еще не дошел до этого урока)

Prodigy [1 day ago]
начал разбираться с темой не в контексте данного урока

Prodigy [1 day ago]
довольно ясно, спасибо!


Merkulov [1 day ago]
EntityManager это по сути прокси обертка над Hibernate Session, которая создается каждый раз при открытии транзакции.

e.pekhterev [1 day ago]
кто создается))? обертка или сессия))? (edited)

Merkulov [1 day ago]
ну прочти еще раз)



e.pekhterev [1 day ago]
ну а ты читал, что мы выше обсуждали?

Stanislav [1 day ago]
http://www.adam-bien.com/roller/abien/entry/is_in_an_ejb_injected


Yevhen Maksymovych [1 day ago]
короче, по сути это пустышка, потому нет проблем, что она везде одна и та же. а при каждой транзакции под эту пустышку подтягивается новая сущность

e.pekhterev [1 day ago]
как я понимаю обертка (EM) таже, а вот сессии в ней каждый раз новые на каждую трансакцию

Stanislav [1 day ago]
 ```With an application-managed entity manager, on the other hand, the persistence context is not propagated to application components, and the lifecycle of EntityManager instances is managed by the application.

Application-managed entity managers are used when applications need to access a persistence context that is not propagated with the JTA transaction across EntityManager instances in a particular persistence unit. In this case, each EntityManager creates a new, isolated persistence context. The EntityManager and its associated persistence context are created and destroyed explicitly by the application. They are also used when directly injecting EntityManager instances can't be done because EntityManager instances are not thread-safe. EntityManagerFactory instances are thread-safe.``` 
(edited)


Yevhen Maksymovych [1 day ago]
вон оно чё

Alexander Pilipenko [1 day ago]
Интересно. А ссылку можно?

Stanislav [1 day ago]
https://docs.oracle.com/javaee/6/tutorial/doc/bnbqw.html



Alexander Pilipenko [1 day ago]
Погоди

Alexander Pilipenko [1 day ago]
У нас

Alexander Pilipenko [1 day ago]
Container-Managed Entity Managers
With a container-managed entity manager, an EntityManager instance’s persistence context is automatically propagated by the container to all application components that use the EntityManager instance within a single Java Transaction API (JTA) transaction.
JTA transactions usually involve calls across application components. To complete a JTA transaction, these components usually need access to a single persistence context. This occurs when an EntityManager is injected into the application components by means of the javax.persistence.PersistenceContext annotation. The persistence context is automatically propagated with the current JTA transaction, and EntityManager references that are mapped to the same persistence unit provide access to the persistence context within that transaction. By automatically propagating the persistence context, application components don’t need to pass references to EntityManager instances to each other in order to make changes within a single transaction. The Java EE container manages the lifecycle of container-managed entity managers.
To obtain an EntityManager instance, inject the entity manager into the application component:
@PersistenceContext
EntityManager em;


e.pekhterev [1 day ago]
вот именно

Alexander Pilipenko [1 day ago]
Жесть :slightly_smiling_face:

Stanislav [1 day ago]
Скинул книгу, страница 227

Alexander Pilipenko [1 day ago]
Как уже выше сказал Григорий - в уроке все  есть :slightly_smiling_face:

Alexander Pilipenko [1 day ago]
Дополнительно (ни разу не сталкивался): еще есть редкий случай ручного управления @PersistenceContext(type = PersistenceContextType.EXTENDED), когда он используется в нескольних транзакциях (long-running session or session-per-conversation). 
Spring and PersistenceContextType.EXTENDED
Transaction-scoped vs Extended Persistence


e.pekhterev [1 day ago]
уже поглядели))

Prodigy [1 day ago]
забавно переводят в разных книга persistance context: "контекст постоянства", "контекст хранения"


tim [4 hours ago]
One question that comes to mind is, how can @PersistenceContext inject an entity manager only once at container startup time, given that entity managers are so short lived, and that there are usually multiple per request.

The answer is that it can't: EntityManager is an interface, and what gets injected in the spring bean is not the entity manager itself but a context aware proxy that will delegate to a concrete entity manager at runtime.

Usually the concrete class used for the proxy is 
SharedEntityManagerInvocationHandler, this can be confirmed with the help a debugger.


Join_Selectovich [Yesterday at 1:42 PM]
Скажите может кто знает? я так подозревают что через HQL/JPQL нельзя сделать сложный запрос например с использованием аналитических функций... если нельзя то можно ли через Hibernate  отправить нативный оракловский запрос с использованием аналитических функций


1 reply
Grigory Kislin [1 day ago]
SQL+ NamedQuery c аттрибутом nativeQuery (edited)


Stanislav [Yesterday at 2:05 PM]
Страница 227
PDF
Изучаем_JavaEE7_2014.pdf
13 MB
PDF
 Click to view





4 replies
sky [1 day ago]
Немного не в тему вопрос, но может кто подскажет. Нужно приложение, с которого было бы удобно читать пдф на винде. На андроиде есть FBreader с плагином, который позволяет обрезать поля (лишнее) для всех страниц одновременно, имеет инверсную (или темную) тему отображения. Читалки что пробовал на винде норм, чтобы что-то глянуть, но читать в них - мучение..


Alexander Pilipenko [1 day ago]
https://ru.fbreader.org/win32
FBReader
FBReader для Windows
Стабильная версия 0.12.10
Oct 29th, 2011 at 10:16 PM


sky [1 day ago]
нагугливался в процессе поиска на это, но там "Последняя на сегодняшний день стабильная версия была выпущена в 2010 году", врядли там пдф плагин есть, хотя я не ставил..


Andrew [1 day ago]
А зачем лишний мусор в компе, через браузер, во вариант!)


Alexander Pilipenko [2:10 PM]
И за книжку спасибо :slightly_smiling_face:


Yevhen Maksymovych [Yesterday at 4:32 PM]
в новом релизе идея научилась строить диаграммы бинов спринга. выглядит, правда, как ночной кошмар


1 reply
Alexey_P [1 day ago]
видел у Тимура Батыршинова в курсе Spring видео 2014 года, там эклипс уже умел кажется


realcorwin [4:33 PM]
ночной кошмар студентки филологического факультета :slightly_smiling_face:


Maksim K [Yesterday at 9:39 PM]
Спасибо за книжечку. Чтоб кто еще про Hibernate на русском скинул книжечку))


14 replies
Stanislav [1 day ago]
В эл. варианте в нете ни чего нет (на русс.). Взял https://www.ozon.ru/context/detail/id/141415731/  и не пожалел. Ozon быстро доставляет (с учетом что я не в России).
Ozon.ru
Книга «Java Persistence API и Hibernate» Кристиан Бауэр, Гэвин Кинг, Гэри Грегори - купить на OZON.ru книгу с быстрой доставкой | 978-5-97060-180-8
Купить книгу «Java Persistence API и Hibernate» автора Кристиан Бауэр, Гэвин Кинг, Гэри Грегори и другие произведения в разделе Книги в интернет-магазине OZON.ru. Доступны цифровые, печатные и аудиокниги. На сайте вы можете почитать отзывы, рецензии, отрывки. Мы бесплатно доставим книгу «Java Persistence API и Hibernate» по Москве при общей сумме заказа от 3500 рублей. Возможна доставка по всей России. Скидки и бонусы для постоянных покупателей. (104 kB)
(edited)


Alexey_P [1 day ago]
написано - товар закончился. Все ломанулись похоже)


Alexey_P [1 day ago]
на английском есть 3 штуки, сам пока не читал.


Maksim K [1 day ago]
Ну я вот эту книжечку и имел ввиду) Сам ее в инете искал на русском скачать. Нету... Надо посмотреть скок стоит. Может купить


Maksim K [1 day ago]
Да. И в наличии уже нет. А на английском я читаю так себе. Да ладно, кого я обманываю, вообще почти не читаю(


Stanislav [1 day ago]
Не надо экономить на такие вещи, месяц пиво не попей. Кому нужно, тот найдет.


Alexey_P [1 day ago]
https://www.labirint.ru/books/596462/
пишут "на складе"
Labirint.RU
Java Persistence API и Hibernate
Java Persistence - механизм, помогающий обеспечить сохранность данных после завершения программы, что является главной чертой современных приложений. Hibernate - наиболее популярный инструмент Java для работы с базами данных, предоставляющим...
 


Alexey_P [1 day ago]
а Яндекс сообщил, что здесь сильно дешевле
https://www.combook.ru/product/11821227/?_openstat=bWFya2V0LnlhbmRleC5ydTvQmtC40L3QsyDQky4sINCR0LDRg9GN0YAg0JouICJKYXZhIFBlcnNpc3RlbmNlIEFQSSDQuCBIaWJlcm5hdGUiO3cyaENsSVdJODA0Y3FjdGp1Um9zNnc7&frommarket=http%3A%2F%2Fmarket.yandex.ru%2Fpartner&ymclid=326342339736131652000001
combook.ru
Java Persistence API и Hibernate
Java Persistence – механизм, помогающий обеспечить сохранность данных после завершения программы, что является главной чертой современных приложений. Hibernate – наиболее популярный инструмент Java дл... (16 kB)


Alexey_P [1 day ago]
и это не месяц пива, а разочек)

Maksim K [1 day ago]
я и так пиво за последний год пару раз пил

Maksim K [1 day ago]
куда уж больше экономить)

Victor [24 hours ago]
попробуй на торрентах посмотри, я оттуда много брал, но я English стараюсь читать, русских нет.


Victor [24 hours ago]
хотя мое мнение доки по hibernate - очень даже хороши


realcorwin [22 hours ago]
Пересылка книг за границу обычно сильно дороже самих книг...


Merkulov [12:15 PM]
Spring Data JPA очень удобная штука, стоит просто правильно написать название метода и все работает!


shtramak [Today at 12:21 PM]
Как я понял из доклада Борисова «Spring Data, да та», этот фреймворк придуман в первую очередь, чтобы легко переключаться между разными базами, в том числе между видами баз (sql, nosql), чтобы определить, какая бд вам нужна. 

Но когда вы уже определись с базой и либой для работы с ней, без нативных запросов и реализаций не обойтись


1 reply
Merkulov [11 hours ago]
я к тому, что простые рутинные запросы делаются легко, понятно, что если делаешь что-то сложное то придется писать нативные запросы


shtramak [12:22 PM]
Потому что серебряной пули не существует


stea1th [Today at 12:53 PM]
ребята, а почему у меня так:



3 replies
sky [10 hours ago]
change profiles



Victor [9 hours ago]
maven не обновил. У меня только что покрасило в красный, я обновил зависимости, и все пропало. В общем у тебя нет зависимости этой


Grigory Kislin [4 hours ago]
выставь профиль справа вверху конфигурации- postgres либо hsqldb


stea1th [12:53 PM]
после патча 5.5

svis [2:34 PM]
У меня возник вопрос про Spring Cache - насколько часто он используется в реальный проектах на продакшн?
Или он как и Spring Data - используется на этапе разработки (тестирование, прототипирование)?


svis [Today at 2:36 PM]
А на продакшн юзают кэш в Хибернейт (edited)


4 replies
vch [9 hours ago]
А чем кэш Hibernate лучше чем Spring Cache?


svis [9 hours ago]
Просто лучше-хуже - это как то слишком общие рассуждения ИМХО:face_with_rolling_eyes: Лучше-хуже для чего? Если говорить об архитектуре - Spring это сборщик других фреймворков среди которых Hibernate. У Хибернейта тоже есть кэширование и оно более низкоуровневое. Использовать кэш спринга очевидно проще.  Но и в роликах Григорий не рекомендует использовать его для данных которые меняются “слишком часто“. Отсюда сразу опасение что там есть проблемы с производительностью ( скажу сразу - не измерял). Отсюда мой вопрос - как часто используется спринг кэш именно на продакшн


vch [9 hours ago]
Я использую, проблем не припомню. 
P.S. Ролик не смотрел


svis [9 hours ago]
OK, спасибо


Grigory Kislin [7:26 PM]
1.  Spring Data (если JPA на проекте) счас стандарт
2. про кэши- если он требуется- то используют. на каждом проекте разные( от спицифика зависит)
если данные часто меняются и их очень много - то НЕ используют (edited)

tema.emelyan [8:26 PM]
я такого никогда ещё не делал, но похоже можно спринг дата репозитории расширять, автоварить туда энтити менеджеры и в итоге довольно гибко получается (edited)
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.customize-base-repository
ну и само собой нативные query даже без всего этого можно делать если в аннотации `@Query(native = true, ...)` (edited)


stea1th [Today at 1:26 PM]
Screenshot_2.png



15 replies
e.pekhterev [5 hours ago]
посмотри что у тебя в Profiles


e.pekhterev [5 hours ago]
public static final String ACTIVE_DB = POSTGRES_DB;


e.pekhterev [5 hours ago]
а у тебя там явно не постгрес, а hsqldb

stea1th [5 hours ago]
Screenshot_3.png



stea1th [5 hours ago]
у нас же автоматом меняться должно


e.pekhterev [5 hours ago]
должно

stea1th [5 hours ago]
значит не тут затык

e.pekhterev [5 hours ago]
Reimport для мавен сделай


stea1th [5 hours ago]
сейчас

e.pekhterev [5 hours ago]
и clean, может починится


stea1th [5 hours ago]
делал


stea1th [5 hours ago]
урл странный стоит


stea1th [5 hours ago]
<beans profile="postgres">
       <context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>

       <bean id="dataSource"
             class="org.apache.tomcat.jdbc.pool.DataSource"
             p:driverClassName="org.postgresql.Driver"
             p:url="${database.url}"
             p:username="${database.username}"
             p:password="${database.password}"/>
   </beans>


e.pekhterev [5 hours ago]
а у тебя случаем не оба профиля в мавене выбраны?


stea1th [5 hours ago]
нет, верхний закоменчен


stea1th [1:26 PM]
почему ничего не работает? сделано все как в видео


Vitaly [Today at 1:32 PM]
написан драйвер от postgre, а url стоит на hsqldb (edited)


1 reply
stea1th [5 hours ago]
так я ничего не менял... это после патчей такое... я тоже это заметил


Vitaly [1:37 PM]
image.png 

так у тебя просто не переключился профиль на postgres
он потянул url из другого prop


stea1th [Today at 1:39 PM]
Screenshot_4.png



28 replies
e.pekhterev [5 hours ago]
этот и не будет никогда переключать, профиль переключается в другом месте.


e.pekhterev [5 hours ago]
1.png



stea1th [5 hours ago]
я похоже знаю где затык


stea1th [5 hours ago]
Screenshot_5.png
 


e.pekhterev [5 hours ago]
ты накатывал 5_5_profiles_connection_pool.patch????


e.pekhterev [5 hours ago]
у тебя уже не должно быть этой строчки вообще


e.pekhterev [5 hours ago]
к пятому занятию уже надо бы научиться патчи по порядку накатывать


stea1th [5 hours ago]
ты думаешь я совсем плохой?

stea1th [5 hours ago]
Screenshot_6.png



e.pekhterev [5 hours ago]
а чего не пушил после каждого патча


e.pekhterev [5 hours ago]
у тебя после 5_5 пачта должны были уйти эти строки


stea1th [5 hours ago]
не знаю... пушу обычно после всех... чтоб можно было откатиться назад


stea1th [5 hours ago]
почему не ушли/?


e.pekhterev [5 hours ago]
spring-db.xml
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:jdbc="http://www.springframework.org/schema/jdbc"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
    http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
    http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">
​
  <context:component-scan base-package="ru.javawebinar.**.repository.jpa"/>
​
  <jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
    <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
    <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
  </jdbc:initialize-database>
​
  <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"
     p:dataSource-ref="dataSource"
     p:packagesToScan="ru.javawebinar.**.model">
    <!--p:persistenceUnitName="persistenceUnit">-->
​
    <property name="jpaPropertyMap">
      <map>
        <entry key="#{T(org.hibernate.cfg.AvailableSettings).FORMAT_SQL}" value="${hibernate.format_sql}"/>
        <entry key="#{T(org.hibernate.cfg.AvailableSettings).USE_SQL_COMMENTS}"
            value="${hibernate.use_sql_comments}"/>
        <entry key="#{T(org.hibernate.cfg.AvailableSettings).JPA_PROXY_COMPLIANCE}" value="false"/>
        <!--<entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_AUTO}" value="${hibernate.hbm2ddl.auto}"/>-->
      </map>
    </property>
​
    <property name="jpaVendorAdapter">
      <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"
         p:showSql="${jpa.showSql}">
      </bean>
    </property>
  </bean>
​
  <tx:annotation-driven/>
​
  <!-- Transaction manager for a single JPA EntityManagerFactory (alternative to JTA) -->
  <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager"
     p:entityManagerFactory-ref="entityManagerFactory"/>
​
  <!--
    <context:component-scan base-package="ru.javawebinar.**.repository.jdbc"/>
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
      <constructor-arg ref="dataSource"/>
    </bean>
​
    <bean id="namedJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
      <constructor-arg ref="jdbcTemplate"/>
    </bean>
  -->
​
  <beans profile="hsqldb">
    <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>
​
    <!--no pooling-->
    <bean id="dataSource"
       class="org.springframework.jdbc.datasource.DriverManagerDataSource"
       p:driverClassName="org.hsqldb.jdbcDriver"
       p:url="${database.url}"
       p:username="${database.username}"
       p:password="${database.password}"/>
  </beans>
​
  <beans profile="postgres">
    <context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>
​
    <bean id="dataSource"
       class="org.apache.tomcat.jdbc.pool.DataSource"
       p:driverClassName="org.postgresql.Driver"
       p:url="${database.url}"
       p:username="${database.username}"
       p:password="${database.password}"/>
  </beans>
</beans>
Collapse


e.pekhterev [5 hours ago]
вот такой должен быть spring-db.xml после патча 5_6_profile_resolver.patch
в нём уже нет тех строк, что ты выше показал, они ушли после патча 5_5


stea1th [5 hours ago]
ну видишь, а они есть


e.pekhterev [5 hours ago]
ещё раз - некорректно накатаны патчи


stea1th [5 hours ago]
хорошо, что я делаю не так... я откачусь до начального состояния


e.pekhterev [5 hours ago]
чтоб я знал, я же сижу рядом, я накатываю патчи по порядку, и ещё ни разу проблем не было


e.pekhterev [5 hours ago]
тьфу тьфу тфьу

stea1th [5 hours ago]
не поверишь... делаю точно так же


e.pekhterev [5 hours ago]
конечно не поверю))) ты уже вродь не первый раз так попадаешь)


stea1th [5 hours ago]
первый


stea1th [5 hours ago]
ты считаешь, что я из разряда особо одаренных и патчи накатываю в рандомном порядке?


e.pekhterev [5 hours ago]
я не знаю, есть проблема, и вижу, что накат выполнен по каким то причинам некорректно, а кто насколько одарен - это не мне судить


stea1th [5 hours ago]
вот и мне интересно, отчего такое проявляется... есть ли момент, который я упускаю


stea1th [5 hours ago]
по идее пушить или не пушить дело каждого... главное по порядку делать Apply Patch


zippospb [2 hours ago]
Посмотри список файлов в каждом из патчей. Патч мог накатиться частично,  если были сделаны какие - то изменения в пропатчиваемом файле. Например, среди файлов в патче 5.5 нет spring-db.xml


stea1th [1:41 PM]
так что надо сделать?


stea1th [Today at 1:41 PM]
почему он не переключает?


38 replies
Grigory Kislin [5 hours ago]
В занятии есть как между hsqldb и postgres переключаться

stea1th [5 hours ago]
надо закоменчивать?


Gagarina6794 [5 hours ago]
Видео внимательно смотреть)


stea1th [5 hours ago]
так в чем затык то? я понимаю, что можно немножко похохотаться, но от этого яснее не станет


e.pekhterev [5 hours ago]
дело не в видео, тут проблема исключительно в накатке патчей


Stanislav [5 hours ago]
Пробовать самому разобраться (не такая уж и сложная проблема). На работе недельку потерпят (у меня там, тут, не работает) и досвиданья скажут.


stea1th [5 hours ago]
может мне код идеи поковырять и выяснить, почему она патчи криво накатывает?


stea1th [5 hours ago]
или я недостаточно прямо по левой кнопки мыши шлепаю на разделе Apply Patch?


Stanislav [5 hours ago]
99% накатывпет норм, а у вас нет...сделайте откат (вы в гите как ни как работаете) накатите заново...смысл ясен, есть вопросы мелочи которые обязан программист сам разбирать, а не дергать постояно того за кем закреплен, а есть реальные серьезные вопросы.


stea1th [5 hours ago]
может дело в версии интелидж? может в самом патче?


stea1th [5 hours ago]
просто что можно сделать не так, накатывая патч?


stea1th [5 hours ago]
может это баг новой версии идеи?


stea1th [5 hours ago]
почему запуская патч, я не получаю уведомления, что что то пошло не так?


stea1th [5 hours ago]
Screenshot_6.png



stea1th [5 hours ago]
даже здесь видно, что spring_db не обновился


stea1th [5 hours ago]
а я пушкин знать что должно вообще было обновиться?


stea1th [5 hours ago]
по большому счету это вопрос к @Grigory Kislin


Gagarina6794 [5 hours ago]
В каждом патче можно даже вручную зайти и посмотреть что меняется


stea1th [5 hours ago]
хорошо, может тогда вы скажете, почему должно меняться, не меняется и об этом не пишется?


Stanislav [5 hours ago]
Ты не Пушкин, ты будующий программист (наверно), любой патч открывается ( хоть блокнотом) и смотрится что в патче.


stea1th [5 hours ago]
вы каждый патч просматриваете ?


Stanislav [5 hours ago]
Да и не просто просматриваю, а вдумчиво и читаю что изменилось (история проекта)


stea1th [5 hours ago]
но после того, как его установили


stea1th [5 hours ago]
и я просматриваю и пытаюсь понять что и как


Stanislav [5 hours ago]
И если с чем то не согласен лезу в гугл и ищу мнения людей


stea1th [5 hours ago]
но я не исхожу из того, что половина в патче просто не поставилась

stea1th [5 hours ago]
видимо вы более продвинуты в этом плане, чем я


Stanislav [5 hours ago]
Нет, просто считаю что профессия программист означает в начале самому разобраться н-ное время, а не сразу дергать людей или задавать на стоковерфлоу вопросы (как у нас уже был какой то тут умник, по jsp на стоковерфлоу вопрос накатал).


stea1th [5 hours ago]
хорошо, можете ли вы ответить на вопрос, почему патч накатывается, а какие то файлы не меняются и об этом не появляется предупреждение?


stea1th [5 hours ago]
вот чисто как программист недопрограммисту


Stanislav [5 hours ago]
С ходу ответить не могу ибо нужен ваш гит, делать форк, разбираться, а мне влом (у самого дел много). Я бы сделал откат на тот коммит который норм и до патчил заново


stea1th [5 hours ago]
а почему такое вообще возможно?


Victor [4 hours ago]
Попробуй проверять галочки на классах когда apply patch. Иногда галочки слетают и не все классы обновляются. У меня так было (кривые руки)


stea1th [4 hours ago]
Все галочки стоят


Victor [4 hours ago]
сейчас уже работает все?


stea1th [4 hours ago]
Не совсем... Короче появляется типа красного поля, что не идея не может поставить... Жмёшь на Apply, и что то ставится, что то нет

stea1th [4 hours ago]
Не знаю как эту проблему решить

Gagarina6794 [3 hours ago]
сделай откат на начало урока до 5.1  и накати заново


Gagarina6794 [3:22 PM]
Вопрос, почему мы здесь не проверяем getCache на null? @Before
   public void setUp() throws Exception {
       cacheManager.getCache("users").clear();
   }  идея об этом предупреждает


Maksim K [Today at 3:50 PM]
Товарищи, вопрос по патчу 5_7. У меня почему то не хочет в помнике применять строку  `<spring-data-jpa.version>2.0.8.RELEASE</spring-data-jpa.version>`. Пишет not applied. Сам патч ставится, но в помник эта строчка не добавляется. ЕЕ просто потом вручную добавить или как?


11 replies
Victor [3 hours ago]
```<spring.version>5.0.7.RELEASE</spring.version>
        <spring-data-jpa.version>2.0.8.RELEASE</spring-data-jpa.version>
        <tomcat.version>8.5.31</tomcat.version>```
у меня так после 7ого патча


Maksim K [3 hours ago]
вот у меня вот эта строка  `<spring-data-jpa.version>2.0.8.RELEASE</spring-data-jpa.version>` не хочет применяться почему-то. в итоге я патч накатил и эту строку вручную добавил. вроде все норм. правда тесты не идут. наверно так надо. еще не дошел до этого


Victor [3 hours ago]
нет, тесты должны идти


Victor [3 hours ago]
но там по видео правильно нужно сделать: нажать clean, выбрать базу в maven и сделать import


Maksim K [3 hours ago]
ща как раз видео смотрю) потом поглядим)

Maksim K [2 hours ago]
все я понял) че ты меня обманываешь?)) не должны тесты проходить. мы же типа ща тестим dataJpa. а там у нас еще никакой реализации. ну юзер тестится, а еда нет


Victor [2 hours ago]
да проходят. Ну user тесты конечно, ане meal.


Victor [2 hours ago]
Я же у себя запускаю

Maksim K [2 hours ago]
я просто тест еды запускал)

Victor [2 hours ago]
хотел meal тест запустить? Крутяк )))

Maksim K [2 hours ago]
ну просто я только патч применил и не видел что там поменялся  <context:component-scan>. попробовал запустить и фиг там) если его закомментить, а наш старый раскомментить, то все работает))


Join_Selectovich [Today at 4:30 PM]
Поясните пожалуйста фразу 
_*При загрузке Meal, Hibernate на основе поля meal.user_id делает ленивую прокcи к User, у которой нет ничего, кроме id.*_
Не могу уловить суть проксирования в чем тут заключается (edited)


10 replies
Join_Selectovich [2 hours ago]
Это получается что создается урезанная  сущность юзер у которой все кроме id пустое? (edited)


shtramak [2 hours ago]
Вместо реального объекта user получается получается прокси


Join_Selectovich [2 hours ago]
Что значит прокси, это сущность в данном случае?


Victor [2 hours ago]
тоесть над объектом user делается обертка в которой есть id. Вместо остальных полей метод. И если обратиться к полю, то будет выполнен метод и поле будет вытянуто из базы

Join_Selectovich [2 hours ago]
наверное обертка над классом User

shtramak [2 hours ago]
Там заморочено конечн)



shtramak [2 hours ago]
Ну это сделано, чтобы экономить время и ресурсы и не тянуть все лишние данные из базы


shtramak [2 hours ago]
Иначе ставится fetchtype.eager


tema.emelyan [2 hours ago]
https://stackoverflow.com/questions/20988626/what-is-proxy-in-the-context-of-load-method-of-hibernate
https://stackoverflow.com/questions/2227836/what-is-the-meaning-of-using-proxy-dynamic-proxy-in-spring-framework (edited)



Join_Selectovich [2 hours ago]
C eager/lazy понятно, не понятно как оно устроено


Join_Selectovich [4:32 PM]
Это в пояснениях перед строкой 
*Apply 5_3_HW4_optional.patch*

shtramak [4:34 PM]
Так у нас же fetch.lazy


stea1th [Today at 4:37 PM]
как откатить патчи до начала пятого урока?


9 replies
Gagarina6794 [2 hours ago]
Сделать ресет ветки на последний коммит


stea1th [2 hours ago]
где он делается


stea1th [2 hours ago]
?


Gagarina6794 [2 hours ago]
В локал чейндж на ветке мастера на последнем коммите правая кнопка мыши и в меню обновление ветки к такому то коммиту


stea1th [2 hours ago]
скрин можешь сделать?


Gagarina6794 [2 hours ago]
Сейчас не могу, немного позже

Gagarina6794 [2 hours ago]
Новый точечный рисунок.bmp



Gagarina6794 [2 hours ago]
versionControl-> log


Gagarina6794 [2 hours ago]
на последнем комите


stea1th [4:37 PM]
так чтобы следов не осталось ... я их не коммитил

Merkulov [4:48 PM]
Для достать по id пользователя вместе с его едой я в User добавил List<Meal> meals 
что-то этого не замечаю после патчев, у всех так?


e.pekhterev [Yesterday at 6:58 PM]
Парни/девушки, какой паттерн проектирования применён в классе DataJpaUserRepositoryImpl?:
- декоратор;
- адаптер;
- другой;
- никакой. (edited)


12 replies
Gagarina6794 [21 hours ago]
CrudUserRepository -адаптер через наследование, и плюс декоратор, так как добавляет свои методы... расширяя входящий интерфейс (edited)


Gagarina6794 [21 hours ago]
А сам JpaRepository какой мутант)) там и декоратор тебе и адаптер) если просмотреть всю историю его наследования...очень интересно (edited)


Gagarina6794 [21 hours ago]
этому паттерну дадим имя Григорий))  (адаптер + декоратор) (edited)
 


Gagarina6794 [20 hours ago]
Но JpaRepository как бы подразумевает написание нами некоторых дополнительных методов по "заклинанию", и он их может запросто сам реализовать... Он упрощает сам процесс декорирования, о как!


Gagarina6794 [20 hours ago]
Но применения к нему адаптера он никак не ожидал))


Grigory Kislin [2 hours ago]
вопрос интересный:)
я бы назвал это композицией с делегированием
если бы стояла бизнес задача преобразовать UserRepository в CrudUserRepository то это был бы адаптер ( у нас нет бизнес задачи, CrudUserRepository  - внутреняя фича нашей реализации data-jpa)
делегат интерфейсов не меняет, а прокси похож на делегата, но служит невной подмены (часто прямо в рантайм)
https://refactoring.guru/ru/design-patterns
refactoring.guru
Паттерны/шаблоны проектирования (59 kB)


Grigory Kislin [1 hour ago]
2. девушки тут тоже присутствуют:)


e.pekhterev [1 hour ago]
@Grigory Kislin апдатед) (edited)


Grigory Kislin [1 hour ago]
:slightly_smiling_face: я тоже в урок добавил



e.pekhterev [1 hour ago]
@Grigory Kislin на самом деле очень приятно, когда начинаешь такие вещи замечать, код и его назначение становится более понятными, надо поучить паттерны конечно)


Grigory Kislin [1 hour ago]
согласен, приятно. мне на собеседовании в мой код по описанию спросили про паттерн, я тогда не смог назвать commander. а bridge у себя в коде сам распознал:)


e.pekhterev [1 hour ago]
@Grigory Kislin вот я как раз про собеседование и подумал - что вполне возможны подобные вопросы (edited)


tema.emelyan [Yesterday at 7:14 PM]
я думаю фасад


15 replies
e.pekhterev [22 hours ago]
а чем тебе не адаптер?


e.pekhterev [22 hours ago]
в плане адаптера - мы полностью выполняем условия.
мы полностью адаптируем CrudUserRepository под UserRepository.
т.е. объект CrudUserRepository через адаптер DataJpaUserRepositoryImpl реализует все методы интерфейса  UserRepository

не согласен?


tema.emelyan [22 hours ago]
да согласен, не прав


tema.emelyan [22 hours ago]
адаптер


e.pekhterev [22 hours ago]
но как бы почему не декоратор?


e.pekhterev [22 hours ago]
Декоратор — это структурный паттерн проектирования, который позволяет динамически добавлять объектам новую функциональность, оборачивая их в полезные «обёртки».


tema.emelyan [22 hours ago]
ну декоратор это когда прокси наверное (edited)


e.pekhterev [22 hours ago]
т.е. в чём дилема - с одной стороны мы декорируем (например меняем поведение метода delete - меняем функциональность), с другой - адапитируем CrudUserRepository под UserRepository
видимо декоратор идет по любому как часть реализации адаптера


e.pekhterev [22 hours ago]
короче задал вопрос, и нашел ответ во время спора))))


tema.emelyan [22 hours ago]
ну не, мы же динамически ничего не меняем


tema.emelyan [22 hours ago]
мне кажется декоратор - это например логгинг через аоп. например у нас был класс, мы через аоп добавляем логгирование, но специально новый класс не создаем для этого


tema.emelyan [22 hours ago]
а здесь создаём новый класс и работаем с новым классом уже


e.pekhterev [22 hours ago]
в декораторе тоже создается новый класс


e.pekhterev [22 hours ago]
надо вообще конечно почитать поподробнее)


Gagarina6794 [21 hours ago]
CrudUserRepository, это таки адаптер, есть адаптеры которые реализуются либо через наследование либо через композицию, здесь через наследование, суть в том что мы таким образом переопределяем методы базового интерфейса(класса) с нужным более широким как правило функционалом ну и плюс декоратор.. (edited)


Victor [10:35 PM]
@Grigory Kislin Тут ошибка? лишнее слово задать...
>2.1: Профили выбора DB (postgres/hsqldb) и реализации репозитория (jdbc/datajpa/jpa) независимы друг от друга и при запуске `задать` приложения (тестов) нужно задать тот и другой.


Gagarina6794 [Today at 7:20 AM]
2: В реализациях JdbcMealRepository код не должен дублироваться.  -  Jdbc или Jpa?


1 reply
sky [10 hours ago]
Jdbc


Andrey [Today at 2:11 PM]
5: Разделить JdbcMealRepositoryImpl для HSQLDB (она не умеет работать с Java8 Time API) и Postgres через @Profile (для Postgres оставить LocalDateTime). 
Может просто версию поднять hsqldb?) он уже научился это делать



8 replies
Merkulov [3 hours ago]
я так понимаю нужно через профили делать, чтобы потренероваться



Merkulov [3 hours ago]
только не совсем понятно как, поидеи должно быть что-то типа такого: есть два бина, которые инджектятся в зависимости от актвного профиля, и должна быть одна ссылка в jdbcMealRepo.. которая должна вставлять правильную конвертацию локалдэйт, тока пока мне не понятно как это реализовать, нужен какой-то общий интерфейс чтобы подставлял динамическую конвертацияю, хотя может и не так все должно быть, пока не знаю


Merkulov [3 hours ago]
какие есть соображения ?

Andrey [3 hours ago]
да как-то сложно получается, hsqldb кушает Timestamp, postgres -обычный LocalDate..


Andrey [3 hours ago]
Т.е. нужен интерфейс с дженериком, который преобразует LocalDateTime либо в LocalDateTime - возвращает его же, либо в Timestamp - Timestamp.valueOf



Andrey [3 hours ago]
две реализации этого интерфейса - для разных профилей, и инжект этого интерфейса в JdbcRepository и использование его там при работе с датами (edited)

Andrey [2 hours ago]
Но выглядит это как изврат какой-то)) для учебных целей только если пойдет, может как-то получше можно?


Grigory Kislin [2 hours ago]
попробуй получше:)


Merkulov [Today at 4:12 PM]
почему при обращении к lazy полю через просто гет вылетает ошибка инициализации типа нет сессии, а если сделать sout(meal.getUser) то все работает?)


3 replies
shtramak [1 hour ago]
Простыми словами, при lazy, поле user заполняется прокси, у которого есть только id. в sout ты просто вызываешь toString, который естественно работает. А вот работа с самим прокси требует сессии.

Ща попробую найти норм ссылку, но суть в том, что эти прокси очень капризные и вне сессии не работают И насколько мне не изменяет память, не будут работать с сессией, в которой они не были созданы


shtramak [39 minutes ago]
чет норм ссылок не нашел, но вроде эти ничего по решению проблемы https://www.javacodegeeks.com/2012/07/four-solutions-to-lazyinitializationexc_05.html (edited)


shtramak [39 minutes ago]
https://www.javacodegeeks.com/2012/07/four-solutions-to-lazyinitializationexc.html (edited)


shtramak [4:17 PM]
выше было обсуждение https://topjava14.slack.com/archives/CBX6WTJQ2/p1532785262000011?thread_ts=1532784621.000009&cid=CBX6WTJQ2
tema.emelyan
https://stackoverflow.com/questions/20988626/what-is-proxy-in-the-context-of-load-method-of-hibernate
https://stackoverflow.com/questions/2227836/what-is-the-meaning-of-using-proxy-dynamic-proxy-in-spring-framework
From a thread in #hw5Yesterday at 4:41 PM


Alexey_P [Today at 4:44 PM]
Помогите разобраться. Меня смущает в задании "3.1 сделать один базовый класс для MealServiceTest и UserServiceTest." Понятно, что в базовый класс какой-нибудь BaseEntityTest можно вынести логгер, StringBuilder для StopWacth и т.д. Но методы вынести не получится. Вернее, можно, но придется плясать с Reflection. Стоит ли овчинка выделки или я что-то не понимаю? Или есть простое и эффективное решение?


16 replies
shtramak [1 hour ago]
а почему тебе понадобится рефлекшн? У тебя в базовом тесте будет поле интерфейса тестируемого класса. К этому интерфейсу ты будешь обращаться и вызывать его методы


shtramak [1 hour ago]
При запуске тестов, junit сам поймет, что класс теста абстрактный и запустит его наследников


Alexey_P [38 minutes ago]
методы тестируемых классов неодинаковы, например, по набору параметров, используют ассерты из разных классов и т.д. Как это обходить?


Alexey_P [33 minutes ago]
если класс теста абсрактный, то в наследниках мы реализовываем все методы теста. И тогда возвращаемся к вопросу - стоит ли овчинка выделки. Хотелось бы приенить шаблонный метод, чтобы реализацию чего-нибудь вынести в суперкласс


shtramak [32 minutes ago]
Хм, можно интерпретировать задание двумя способами
1. один базовый класс для meal и user
2. один базовый класс для всех mealrepo и один базовый класс для всех userrepo

И я думаю по логике второе


shtramak [32 minutes ago]
Сделать тесты всех реализаций (jdbc, jpa, datajpa) через наследование (без дублирования)


Alexey_P [27 minutes ago]
Наверное, это задача связана с "2: Разделить реализации Repository по профилям Spring: jdbc, jpa, datajpa", которую я пока не знаю как делать)


sky [27 minutes ago]
3 абстрактных - 1 общий, 1 для милов, 1 для юзеров, и 6 их реализаций


Alexey_P [26 minutes ago]
по поводу интерпретации, там однозначно - "сделать один базовый класс для MealServiceTest и UserServiceTest"


Grigory Kislin [23 minutes ago]
делать просто и красиво. лишнего ничего не надо


Grigory Kislin [22 minutes ago]
рекомендую этот принцип везде где можно, не только тут

Alexey_P [22 minutes ago]
а что за 6 реализации? Тесты сервиса вроде никак не меняются, могут меняться профайлы Spring'а. кроче, я запутался).


sky [20 minutes ago]
jdbc, jpa, datajpa для милов и те же для юзеров - итого 6. Т.е. у каждой реализации @ActiveProfiles свой. При этом сама реализация пустая. Как по другому запустить каждый тест, для каждой из технологий, я придумать не смог, но Григорий намекнул, что вроде как сие не есть гуд. (edited)


Alexey_P [12 minutes ago]
sky, еще раз напишу - тесты у нас никак не меняются при тестировании разных репозитариев, должны просто переключаться профили для разных реализации репозитариев, как в случае с ВИ резольвером.   Так какие 6 разных реализаций? Или я неправильно понимаю?


Alexey_P [11 minutes ago]
а, ну вот видишь, мы об одном говорим

sky [2 minutes ago]
Может конечно тесты просто должны выполнятся для одного конкретного активного профиля, и тогда можно было бы ограничится 1 абстрактным общим классом и 2умя реализациями для милов и юзеров (т.е. что то типа ActiveApiProfileResolver), но я задание понял, что сделать надо сразу для всех


Merkulov [5:26 PM]
Кто сталкивался с циклической зависимостью полей у User' а при сравнение ожидаемого значения с фактическим в тестах?
